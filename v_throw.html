<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>鉛直投げ上げゲーム〜5球で10点取れ！〜</title>
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --accent:#6ae3ff; --accent2:#8effa1; --text:#e8edf2; --muted:#9aa7b3;
    --ok:#8effa1; --ng:#ff9aa8; --yellow:#ffd36a;
  }
  *{box-sizing:border-box}
  html, body{height:100%;}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif;
    background: radial-gradient(1200px 600px at 70% -10%, #1a1f38, #0b0e1a 60%), var(--bg);
    color:var(--text); display:flex; min-height:100svh; align-items:center; justify-content:center; padding:16px;
  }
  @supports (min-height: 100dvh){ body{ min-height:100dvh; } }

  .app{width:min(980px,100%); display:grid; gap:12px}
  .title{font-weight:700; letter-spacing:.02em; font-size:clamp(18px,3vw,28px); text-align:center}

  .challengeBox{
    display:flex; flex-wrap:nowrap; gap:10px; align-items:center; justify-content:flex-start;
    padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
  }
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:14px; background:rgba(255,255,255,.08); color:var(--yellow); flex-shrink:0;}
  #challengeTextHUD{font-weight:700; flex-grow:1;}
  #scoreHUD{font-variant-numeric: tabular-nums; font-weight:900}

  .perfect{ color:#b7fffb; font-weight:900; margin-left:8px; text-shadow:0 0 10px rgba(106,227,255,.55); }
  .excellent{ color:#8fffd6; font-weight:800; margin-left:8px }
  .great{color:#a7ff6a; font-weight:800; margin-left:8px}
  .good{color:var(--ok); font-weight:800; margin-left:8px}
  .ok{color:#ffd36a; font-weight:800; margin-left:8px}
  .bad{color:#ff9aa8; font-weight:800; margin-left:8px}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.00));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
  }

  .roulette{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center}
  .bar{
    height:16px; background:#111528; border-radius:999px; overflow:hidden; position:relative;
    border:1px solid rgba(255,255,255,.08);
  }
  .fill{
    height:100%; width:0%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width .06s linear;
    box-shadow: 0 0 10px rgba(106,227,255,.6), inset 0 0 8px rgba(0,0,0,.3);
  }
  .speed{font-variant-numeric: tabular-nums; font-weight:800; letter-spacing:.02em; min-width:10ch; text-align:right; font-size:18px}

  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:center}
  button {
    appearance:none; border:none; border-radius:12px;
    padding:14px 20px;
    font-weight:700; cursor:pointer;
    font-size: clamp(22px, 3.8vw, 34px);
    color:#03131a;
    background:linear-gradient(180deg, #8ff2ff, #6ae3ff);
    box-shadow: 0 8px 22px rgba(106,227,255,.35), inset 0 1px 0 rgba(255,255,255,.6);
  }
  @media (min-width: 820px) {
    button { font-size: clamp(34px, 3.8vw, 53px); padding: 18px 28px; }
  }
  button.secondary{
    background:linear-gradient(180deg, #d7e7ff, #b8cfff);
    box-shadow: 0 8px 22px rgba(184,207,255,.28), inset 0 1px 0 rgba(255,255,255,.6);
  }
  button:disabled{opacity:.5; cursor:not-allowed}

  .playgrid{display:grid; grid-template-columns: 1fr; gap:10px; align-items:start}
  @media (orientation: portrait){
    .playgrid{grid-template-columns: 1fr 1fr; grid-template-areas: 'scene readouts';}
    .scene{grid-area: scene}
    .readouts{grid-area: readouts}
  }
  @media (orientation: landscape){
    .playgrid{grid-template-columns: 1fr 1fr; grid-template-areas: 'scene readouts';}
    .scene{grid-area: scene}
    .readouts{grid-area: readouts}
  }

  .scene{
    position:relative; height:420px; border-radius:14px; overflow:hidden; margin-top:10px;
    background:
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)),
      radial-gradient(800px 260px at 50% 0%, rgba(106,227,255,.08), rgba(0,0,0,0) 60%),
      #0b1022;
    border:1px solid rgba(255,255,255,.08);
  }
  .ground{position:absolute; inset:auto 0 0 0; height:8px; background:#1a2039; box-shadow: 0 -2px 0 rgba(255,255,255,.06) inset}
  .meter{position:absolute; right:10px; top:10px; font-size:12px; color:var(--muted);
    background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); padding:6px 8px; border-radius:8px; z-index:1}

  .grid{position:absolute; inset:0 0 8px 0; pointer-events:none;}
  .gridline{position:absolute; left:8px; right:8px; height:1px; background:rgba(255,255,255,.22); opacity:.7}
  .gridlabel{position:absolute; right:10px; transform:translateY(-50%); font-size:11px; color:var(--muted); background:rgba(0,0,0,.35); padding:1px 6px; border-radius:999px; border:1px solid rgba(255,255,255,.12)}

  .hline{position:absolute; left:8px; right:8px; height:2px; background:#ff5b5b; box-shadow:0 0 8px rgba(255,91,91,.6);}
  .ball{
    position:absolute; left:50%; transform:translateX(-50%);
    width:18px; aspect-ratio:1; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff, #bfeaff 30%, #6ae3ff 45%, #0aa3c0 70%, #067089 100%);
    box-shadow: 0 8px 24px rgba(106,227,255,.45);
  }

  .readouts{display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:10px}
  @media (max-width: 980px){ .readouts{grid-template-columns:1fr 1fr} }
  @media (orientation: portrait){ .readouts{grid-template-columns:1fr; align-content:start} }
  .stat{background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px}
  .stat .label{color:var(--muted); font-size:12px; letter-spacing:.02em}
  .stat .value{font-variant-numeric: tabular-nums; font-weight:800; font-size:22px}

  @media (min-width: 820px) {
    .title{ font-size: clamp(24px, 2.6vw, 36px); }
    .challengeBox{ padding:12px 16px; gap:16px; }
    .badge{ font-size: 26px; padding:8px 18px; }
    #challengeTextHUD{ font-size: clamp(31px, 2.9vw, 43px); }
    #scoreHUD{ font-size: clamp(43px, 3.8vw, 53px); }
    .speed{ font-size: clamp(43px, 3.8vw, 53px); }
    .bar{ height: 22px; }
    .stat .label{ font-size: 16px; }
    .stat .value{ font-size: clamp(30px, 2.6vw, 40px); }
  }

  @media (orientation: landscape) and (min-width: 768px) and (max-width: 1180px) {
    .title{ font-size: 20px; }
    #challengeTextHUD{ font-size: 28px; }
    #scoreHUD, .speed{ font-size: 34px; }
    .stat .value{ font-size: 24px; }
    .stat .label{ font-size: 14px; }
    .bar{ height: 18px; }
  }

  #leaderboardCardMobile{ display:none; }
  @media (max-width: 640px){
    .playgrid{ grid-template-columns: 1fr 1fr; grid-template-areas: "scene readouts"; gap:10px; }
    .scene{ grid-area: scene; min-width:0; }
    .readouts{ grid-area: readouts; min-width:0; grid-template-columns: 1fr; }
    #leaderboardCard{ display:none; }
    #leaderboardCardMobile{ display:block; margin-top:10px; }
  }

  #challengeTextHUD, .speed { color:#ff5b5b !important; }
  .submitBox{ display:none; margin-top:12px; padding:12px; border:1px solid rgba(255,255,255,.12); border-radius:12px; background:rgba(255,255,255,.06); }
  .submitBox h3{ margin:0 0 8px 0; font-size:16px; }
  .submitRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .submitRow input[type="text"]{ flex:1; min-width:180px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#0f1430; color:#fff; font-size:16px; }
  .submitRow button{ padding:10px 14px; border-radius:10px; border:none; font-weight:700; cursor:pointer; color:#03131a; background:linear-gradient(180deg, #b1ffd1, #7affaf); box-shadow: 0 8px 22px rgba(122,255,175,.28); }
  .helpText{ font-size:12px; color:#cfe3ff; opacity:.9; margin-top:6px; }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#0b1022; color:#eafff3; padding:10px 14px; border:1px solid rgba(255,255,255,.1); border-radius:10px; display:none; z-index:9999}
  #leaderboardCard{ grid-column: 1 / -1; }
</style>
</head>
<body>
  <main class="app">
    <div class="title">鉛直投げ上げゲーム〜5球で10点取れ！〜</div>

    <div class="challengeBox" id="challengeBox">
      <span class="badge" id="roundBadgeHUD">ラウンド1/5</span>
      <span id="challengeTextHUD">—</span>
      <span id="resultTextHUD"></span>
      <span>｜スコア <strong id="scoreHUD">0点</strong></span>
    </div>

    <section class="card" id="card">
      <div class="roulette" aria-live="polite">
        <div class="bar" aria-label="初速ルーレット（0〜35 m/s を4.5秒で周回）">
          <div class="fill" id="fill"></div>
        </div>
        <div class="speed" id="speedLabel">0.00 m/s</div>
      </div>
      <div class="actions">
        <button id="lockBtn">投射！(L)</button>
        <button id="retryBtn" class="secondary" disabled>次のラウンド(N)</button>
        <button id="resetBtn" class="secondary" style="display:none">もう一度</button>
      </div>

      <div class="playgrid">
        <div class="scene" id="scene">
          <div class="meter">g = 9.8 m/s²</div>
          <div class="grid" id="grid"></div>
          <div class="hline" id="hline" style="bottom:8px;"></div>
          <div class="ball" id="ball" style="bottom:8px"></div>
          <div class="ground"></div>
        </div>

        <div class="readouts" id="readouts">
          <div class="stat"><div class="label">現在の高さ y</div><div class="value" id="yNow">0.00 m</div></div>
          <div class="stat"><div class="label">最高到達高度 H</div><div class="value" id="hVal">0.00 m</div></div>
          <div class="stat"><div class="label">時間 t</div><div class="value" id="tVal">0.00 s</div></div>

          <section class="card" id="leaderboardCard" aria-live="polite">
            <h3 style="margin:0 0 8px">トップ20(※平常点的には「提出できたか否か」のみの判断)</h3>
            <div id="leaderboard">読み込み中…</div>
          </section>
        </div>
      </div>

      <section class="card" id="leaderboardCardMobile" aria-live="polite">
        <h3 style="margin:0 0 8px">トップ20(※平常点的には「提出できたか否か」のみの判断)</h3>
        <div id="leaderboardMobile">読み込み中…</div>
      </section>
    </section>
  </main>

  <div class="submitBox" id="submitBox" style="display:none" aria-live="polite">
    <h3>提出</h3>
    <div class="submitRow">
      <label for="studentId">4桁番号(年組番、半角)：</label>
      <input id="studentId" type="text" placeholder="3143" inputmode="numeric" />
    </div>
    <div class="submitRow">
      <label for="studentName">氏名：</label>
      <input id="studentName" type="text" placeholder="海城太郎" />
      <button id="submitBtn">送信</button>
    </div>
    <div class="helpText" id="submitHelp">10点以上で提出できます。</div>
  </div>
  <div class="toast" id="toast"></div>

<script>
(() => {
/* ========= GAS エンドポイント ========= */
/* ★★★ 必ず自分のデプロイURLに差し替えてください ★★★ */
const GAS_SESSION_URL = 'https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXX/exec?fn=session';
const GAS_LOCK_URL    = 'https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXX/exec?path=lock';
const GAS_SUBMIT_URL  = 'https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXX/exec?path=submit';

/* ランキングの公開CSV（必要に応じて差し替え） */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ10LcB0wupR7ip5mhf_WskxAZiQQIXytBQ45Sxyf2ej9R1xULe-iQbj7RU2TgNXOrjTrUVefFQOEIO/pub?gid=1876521549&single=true&output=csv";

/* ========= 物理・ルール ========= */
const RULE = {
  version: 'vthrow-v1.0',
  g: 9.8, vMin: 0, vMax: 35, cycleSec: 4.5, rounds: 5,
  HTARGETS: [4.9, 19.6, 44.1],   // 最高到達高度 [m]
  TTARGETS: [1, 2, 3, 4, 6],     // 着地までの時間 [s]
  scoreBands: [
    { lt: 0.01, pts: 5, label: 'PERFECT!!!!', cls:'perfect', decimals:2 },
    { lt: 0.03, pts: 4, label: 'Excellent!!!', cls:'excellent', decimals:1 },
    { lt: 0.10, pts: 3, label: 'great!!',      cls:'great',     decimals:1 },
    { lt: 0.20, pts: 2, label: 'good!',        cls:'good',      decimals:1 },
    { lt: 0.30, pts: 1, label: 'ok',           cls:'ok',        decimals:1 },
  ]
};

/* ========= DOM ========= */
const fillEl=document.getElementById('fill');
const speedLabel=document.getElementById('speedLabel');
const lockBtn=document.getElementById('lockBtn');
const retryBtn=document.getElementById('retryBtn');
const resetBtn=document.getElementById('resetBtn');
const scene=document.getElementById('scene');
const gridEl=document.getElementById('grid');
const hLine=document.getElementById('hline');
const ball=document.getElementById('ball');
const yNowEl=document.getElementById('yNow');
const hValEl=document.getElementById('hVal');
const tValEl=document.getElementById('tVal');
const roundBadgeHUD=document.getElementById('roundBadgeHUD');
const challengeTextHUD=document.getElementById('challengeTextHUD');
const resultTextHUD=document.getElementById('resultTextHUD');
const scoreHUD=document.getElementById('scoreHUD');
const submitBox = document.getElementById('submitBox');
const submitBtn = document.getElementById('submitBtn');
const studentIdInput = document.getElementById('studentId');
const studentNameInput = document.getElementById('studentName');
const toast = document.getElementById('toast');
const showToast = (m)=>{ toast.textContent=m; toast.style.display='block'; setTimeout(()=>toast.style.display='none',2200) };

/* ========= クライアント識別トークン（重複提出のユニーク化に利用可能） ========= */
const CLIENT_TOKEN_KEY = 'vthrow_client_token';
function getClientToken(){
  try{
    let tk = localStorage.getItem(CLIENT_TOKEN_KEY);
    if(!tk){
      tk = (typeof crypto!=='undefined' && crypto.randomUUID) ? crypto.randomUUID()
           : 'ct-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,10);
      localStorage.setItem(CLIENT_TOKEN_KEY, tk);
    }
    return tk;
  }catch(e){ return ''; }
}
const clientToken = getClientToken();

/* ========= セッション ========= */
let session = {
  sessionId:'', nonce:'', ruleVersion: RULE.version, serverG: RULE.g,
  t0Ms:0, phiSec:0, offsetMs:0, rttMs:0, ticketSig:''
};
async function fetchSession(){
  try{
    const t1 = Date.now();
    const r = await fetch(GAS_SESSION_URL + '&t1=' + t1, { method:'GET', cache:'no-store', credentials:'omit', headers:{'Accept':'application/json'} });
    const j = await r.json().catch(()=>null);
    if(!j || !j.ok) throw new Error('session_fail');
    const t3 = Date.now();
    const echoT1 = Number(j.echoT1 ?? t1);
    const rtt = Math.max(0, t3 - echoT1);
    const offset = Number(j.serverNow) - (echoT1 + rtt/2);
    session = {
      sessionId: String(j.sessionId||''),
      nonce: String(j.nonce||''),
      ruleVersion: String(j.ruleVersion ?? RULE.version),
      serverG: Number(j.g ?? RULE.g) || RULE.g,
      t0Ms: Number(j.t0Ms||0),
      phiSec: Number(j.phiSec||0),
      ticketSig: String(j.ticketSig||''),
      offsetMs: offset,
      rttMs: rtt
    };
    RULE.version = session.ruleVersion;
  }catch(e){
    console.error(e);
    showToast('セッション取得に失敗（提出不可の可能性）');
  }
}
function ensureSessionReady(){ return !!(session.sessionId && session.nonce && session.ticketSig); }

/* ========= ラウンド管理 & チケット ========= */
let currentRound = 1;
let challenge = null; // { type:'H'|'T', target:number }
let finished = false;
let attemptId = null;
let currentTicket = null;
const ticketsByRound = new Map();
function newAttempt(){
  attemptId = 'a-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
  ticketsByRound.clear();
}

/* ========= サーバLock(Open/Close) ========= */
async function lockOpen(round){
  const body = new URLSearchParams({
    sessionId: String(session.sessionId),
    nonce: String(session.nonce),
    round: String(round),
    intent: 'open',
    t0Ms: String(session.t0Ms),
    phiSec: String(session.phiSec),
    ticketSig: String(session.ticketSig||''),
    ruleVersion: String(session.ruleVersion || RULE.version)
  });
  const res = await fetch(GAS_LOCK_URL, {
    method:'POST', body, credentials:'omit',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8', 'Accept':'application/json' }
  });
  const j = await res.json().catch(()=>null);
  if(!j || !j.ok) throw new Error('lock_open_fail:' + (j && j.error));
  return j; // { ok, challenge:{type,target} }
}
async function lockClose(round, tClick){
  const body = new URLSearchParams({
    sessionId: session.sessionId,
    nonce: session.nonce,
    round: String(round),
    intent: 'close',
    tClick: String(tClick),
    offsetMs: String(session.offsetMs),
    rttMs: String(session.rttMs),
    t0Ms: String(session.t0Ms),
    phiSec: String(session.phiSec),
    ticketSig: String(session.ticketSig||''),
    ruleVersion: String(session.ruleVersion || RULE.version),
  });
  const res = await fetch(GAS_LOCK_URL, {
    method:'POST', body, credentials:'omit',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8', 'Accept':'application/json' }
  });
  const text = await res.text();
  let j = null; try{ j = JSON.parse(text); }catch{}
  if(!j || !j.ok) throw new Error('lock_close_fail:' + (j && j.error || text));
  return j; // { ok, v0, ticket, sig }
}

/* ========= ルーレット（サーバ基準時刻で表示） ========= */
let running = true, locked = false;
let visualV = 0;
function vFromNowMs(nowMs){
  const t = (nowMs - session.t0Ms) / 1000;
  const phase = (t + session.phiSec) % RULE.cycleSec; // （サーバphiSecとフロントの見た目周期は揃える）
  const unit = (phase / RULE.cycleSec);
  return RULE.vMin + unit * (RULE.vMax - RULE.vMin);
}
function updateSpeedUI(v){
  const c = Math.max(RULE.vMin, Math.min(RULE.vMax, v));
  const ratio = (c - RULE.vMin)/(RULE.vMax - RULE.vMin);
  fillEl.style.width = (ratio*100).toFixed(2) + '%';
  speedLabel.textContent = c.toFixed(2) + ' m/s';
}
function rouletteLoop(){
  if(!running) return;
  const displayNow = Date.now() + session.offsetMs;
  visualV = vFromNowMs(displayNow);
  updateSpeedUI(visualV);
  requestAnimationFrame(rouletteLoop);
}

/* ========= レイアウト ========= */
const groundOffsetPx=8;
let currentScale = 8;
function sceneHeight(){ return scene.clientHeight - groundOffsetPx; }
function scalePxPerMeterForMaxMeters(maxMeters){
  const maxPx = sceneHeight() - 26;
  return Math.max(0.5, maxPx / Math.max(maxMeters,1e-6));
}
function renderGrid(scale){
  const s = (typeof scale==='number') ? scale : currentScale;
  gridEl.innerHTML = '';
  const marks = [0,10,20,30,40,50,60];
  const hGrid = sceneHeight();
  for(const m of marks){
    const bottom = groundOffsetPx + m*s;
    if (bottom<groundOffsetPx || bottom>hGrid+groundOffsetPx-2) continue;
    const line=document.createElement('div');
    line.className='gridline';
    line.style.bottom=bottom+'px';
    gridEl.appendChild(line);
    const lab=document.createElement('div');
    lab.className='gridlabel';
    lab.style.bottom=bottom+'px';
    lab.textContent = m + ' m';
    gridEl.appendChild(lab);
  }
}
function fitSceneToViewport(){
  const vh = (window.visualViewport?.height) ? Math.min(window.innerHeight, window.visualViewport.height) : window.innerHeight;
  const margin = 12;
  const topNow = scene.getBoundingClientRect().top;
  let desired = Math.floor(vh - topNow - margin);
  desired = Math.max(220, Math.min(desired, vh - margin));
  const prev = parseFloat(getComputedStyle(scene).height);
  if(!isNaN(prev) && Math.abs(prev - desired) < 2) return;
  scene.style.height = desired + 'px';
  currentScale = scalePxPerMeterForMaxMeters(60);
  renderGrid();
  hLine.style.bottom = groundOffsetPx + 'px';
  ball.style.bottom = groundOffsetPx + 'px';
}

/* ========= サウンド ========= */
let audioCtx=null;
function beep(freq=880,duration=0.15,type='sine',gain=0.08){ try{
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const t0=audioCtx.currentTime; const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
  osc.type=type; osc.frequency.value=freq; g.gain.value=gain; osc.connect(g).connect(audioCtx.destination);
  osc.start(t0); g.gain.setValueAtTime(gain,t0); g.gain.exponentialRampToValueAtTime(0.0001,t0+duration); osc.stop(t0+duration+0.02);
}catch(e){} }
const okSound = ()=>beep(740,0.12);
const goodSound = ()=>{beep(880,0.12); setTimeout(()=>beep(1175,0.12),120);};
const greatSound= ()=>{beep(1047,0.10); setTimeout(()=>beep(1319,0.10),110); setTimeout(()=>beep(1661,0.14),230);};
const wrongSound= ()=>{beep(220,0.25,'square',0.06); setTimeout(()=>beep(175,0.25,'square',0.05),120);};

/* ========= ゲーム進行 ========= */
const maxRounds = RULE.rounds;
let score=0, lastGainedPoints=0;

async function setupRound(){
  if (currentRound === 1 && !attemptId) newAttempt();
  if (!ensureSessionReady()){
    showToast('セッション未確立のため開始できません（再読み込み推奨）');
    lockBtn.disabled = true;
    retryBtn.disabled = false;
    return;
  }
  // 課題取得（open）
  let openResp;
  try{
    openResp = await lockOpen(currentRound);
  }catch(e){
    console.error(e); showToast('サーバーに接続できません。(課題取得失敗)');
    lockBtn.disabled = true; retryBtn.disabled = false;
    return;
  }
  challenge = openResp.challenge; // {type, target}
  challengeTextHUD.textContent = (challenge.type==='H')
    ? `最高到達高度 H = ${challenge.target} m を目指せ！`
    : `着地までの時間 t = ${challenge.target} s を目指せ！`;
  resultTextHUD.textContent = '';
  roundBadgeHUD.textContent = `ラウンド${currentRound}/${RULE.rounds}`;

  fitSceneToViewport();
  renderGrid(); hLine.style.bottom = groundOffsetPx + 'px'; ball.style.bottom = groundOffsetPx + 'px';
  yNowEl.textContent='0.00 m'; hValEl.textContent='0.00 m'; tValEl.textContent='0.00 s';

  running=true; locked=false; lockBtn.disabled=false; retryBtn.disabled=true;
  requestAnimationFrame(rouletteLoop);
}

function animateThrow(v0){
  const g = RULE.g;
  const s = currentScale;
  const T = 2*v0/g;
  const H = (v0*v0)/(2*g);
  const tPeak = v0/g;
  const start = performance.now();
  function step(now){
    const t=(now-start)/1000;
    const tC=Math.max(0,Math.min(T,t));
    const y = Math.max(0, v0*tC - 0.5*g*tC*tC);
    ball.style.bottom = (groundOffsetPx + y*s) + 'px';
    const hDisp = (tC <= tPeak) ? y : H;
    hLine.style.bottom = (groundOffsetPx + hDisp*s) + 'px';
    yNowEl.textContent = y.toFixed(2)+' m';
    hValEl.textContent = ((tC <= tPeak) ? y : H).toFixed(2)+' m';
    tValEl.textContent = tC.toFixed(2)+' s';
    if(t < T - 1e-3) requestAnimationFrame(step);
    else{
      ball.style.bottom = groundOffsetPx + 'px';
      yNowEl.textContent='0.00 m'; hValEl.textContent=H.toFixed(2)+' m'; tValEl.textContent=T.toFixed(2)+' s';
      hLine.style.bottom = (groundOffsetPx + H*s) + 'px';
      evaluateAndProceed(H,T);
    }
  }
  requestAnimationFrame(step);
}

function evaluateAndProceed(H,T){
  const errPct = (challenge.type==='H')
    ? Math.abs(H - challenge.target) / challenge.target
    : Math.abs(T - challenge.target) / challenge.target;

  let band = null;
  for(const b of RULE.scoreBands){ if (errPct < b.lt){ band = b; break; } }
  if (band){
    score += band.pts;
    const pct = (errPct*100).toFixed(band.decimals);
    resultTextHUD.innerHTML = `<span class="${band.cls}">${band.label}（誤差 ${pct}% / +${band.pts}点）</span>`;
    (band.pts>=3 ? greatSound : goodSound)();
  }else{
    resultTextHUD.innerHTML = `<span class="bad">miss…（誤差 ${(errPct*100).toFixed(1)}%）</span>`;
    wrongSound();
  }
  scoreHUD.textContent = String(score) + '点';
  lastGainedPoints = band ? band.pts : 0;

  lockBtn.disabled = true;
  retryBtn.disabled = false;

  if (currentRound >= RULE.rounds){
    const finalMsg = (score >= 10) ? '課題クリア！' : '10点目指してもう1度頑張ろう！';
    resultTextHUD.innerHTML =
      `<div>5回目の得点：<strong>+${lastGainedPoints}点</strong></div>` +
      `<div>全${RULE.rounds}回の合計スコア：<strong>${score}点</strong></div>`;
    challengeTextHUD.textContent = finalMsg;
    retryBtn.style.display='none';
    resetBtn.style.display='inline-block';
    finished = true; locked = true; running = false;

    if (score >= 10) { showSubmitBox(); }
    else { submitBox.style.display='none'; showToast('今回はスコアが10点未満のため提出できません'); }
  }
}

/* ========= 進行ボタン ========= */
lockBtn.addEventListener('click', async ()=>{
  if (finished) { showToast('5投が終わりました。提出かリセットをしてください'); return; }
  if (locked) return;
  if (ticketsByRound.has(currentRound)) { showToast('このラウンドは記録済みです'); return; }

  locked = true; running = false;
  lockBtn.disabled = true; retryBtn.disabled = true;

  try{
    const tClickLocal = Date.now();
    const j = await lockClose(currentRound, tClickLocal); // {v0,ticket,sig}
    const v0 = Number(j.v0);
    const received = { ticket: { ...j.ticket, attemptId }, sig: j.sig, v0 };
    ticketsByRound.set(currentRound, received);
    currentTicket = j.ticket;
    animateThrow(v0);
  }catch(e){
    console.error(e);
    showToast('サーバに接続できません（ロック失敗）');
    locked = false; running = true; lockBtn.disabled = false; retryBtn.disabled = true;
    requestAnimationFrame(rouletteLoop);
  }
});
retryBtn.addEventListener('click', ()=>{
  if (finished) { showToast('5投が終わりました。提出かリセットをしてください'); return; }
  if(currentRound < RULE.rounds) currentRound += 1;
  setupRound();
});
resetBtn.addEventListener('click', ()=>{
  finished=false; currentRound=1; score=0; lastGainedPoints=0; scoreHUD.textContent='0点';
  newAttempt();
  retryBtn.style.display='inline-block'; resetBtn.style.display='none';
  submitBox.style.display='none'; submitBtn.disabled=false; studentIdInput.disabled=false; studentNameInput.disabled=false;
  studentIdInput.value=''; studentNameInput.value='';
  locked=false; running=true; setupRound(); requestAnimationFrame(rouletteLoop);
  window.scrollTo({top:0, behavior:'instant'});
});
document.addEventListener('keydown',(e)=>{
  const ae=document.activeElement; const tag=ae?.tagName;
  if(tag==='INPUT'||tag==='TEXTAREA'||ae?.isContentEditable) return;
  if(e.repeat) return;
  const k=(e.key||'').toLowerCase();
  if(k==='l'||e.code==='KeyL'){ if(!lockBtn.disabled && !locked){ lockBtn.click(); e.preventDefault(); } return; }
  if(k==='n'||e.code==='KeyN'){ const hidden=retryBtn.style.display==='none'; if(!retryBtn.disabled && !hidden){ retryBtn.click(); e.preventDefault(); } }
});

/* ========= 提出 ========= */
function showSubmitBox(){ submitBox.style.display='block'; studentIdInput.focus(); }
async function submitResult(){
  if (ticketsByRound.size !== RULE.rounds) { showToast(`提出データが不足しています（${ticketsByRound.size}/${RULE.rounds}）`); return; }
  let all = Array.from(ticketsByRound.values()).sort((a,b)=> Number(a.ticket.round) - Number(b.ticket.round));
  if (all.length !== RULE.rounds){ showToast('提出データが不足しています'); return; }
  const roundsOK = all.every((t,i)=> Number(t.ticket.round) === i+1);
  const attemptOK = all.every(t => t.ticket.attemptId === attemptId);
  if (!roundsOK || !attemptOK){ showToast('提出データが「直近の5投」だけになっていません（リセット→やり直し推奨）'); return; }

  // ローカル再採点（任意・UI同期用）
  try{
    const recalc = localServerLikeTotal(all.map(x=>({
      round: Number(x.ticket.round),
      tClickAdj: Number(x.ticket.tClickAdj),
      type: String(x.ticket.type),
      target: Number(x.ticket.target),
      v0: Number(x.v0),
      t0Ms: Number(x.ticket.t0Ms),
      phiSec: Number(x.ticket.phiSec)
    })));
    score = recalc.total; scoreHUD.textContent = score + '点';
  }catch(e){ console.warn('local scoring failed', e); }

  const studentId = studentIdInput.value.trim();
  const studentName = studentNameInput.value.trim();
  if(!/^\d{4}$/.test(studentId) || !studentName){ showToast('4桁番号(半角)と氏名を入力してください'); return; }
  if(!session.sessionId || !session.nonce){ showToast('セッション取得に失敗。ページ再読み込みを試してください'); return; }

  // セッション再取得（ruleVersion/ticketSig 更新検知）
  try{ await fetchSession(); }catch(e){ showToast('セッション再取得に失敗しました。ページを再読み込みしてください'); submitBtn.disabled=false; return; }
  const allRuleOK = all.every(x => String(x.ticket?.ruleVersion) === String(session.ruleVersion));
  if (!allRuleOK){ showToast('サーバのバージョンが更新されました。ページを再読み込みして最初から実行してください'); return; }

  const payloadTickets = all.map(x => ({
    ...x.ticket,  // sessionId, round, tClickAdj, type, target, ruleVersion, t0Ms, phiSec
    v0: x.v0,     // 任意（サーバ側で無視はしないが、再構築で二重チェック）
    sig: x.sig
  }));

  submitBtn.disabled = true;
  try{
    const body = new URLSearchParams({
      studentId,
      studentName,
      sessionId: String(session.sessionId),
      nonce: String(session.nonce),
      ticketSig: String(session.ticketSig || ''),
      ruleVersion: String(session.ruleVersion || RULE.version),
      t0Ms: String(session.t0Ms),
      phiSec: String(session.phiSec),
      clientToken: String(clientToken || ''),
      tickets: JSON.stringify(payloadTickets)
    });
    const res = await fetch(GAS_SUBMIT_URL, {
      method:'POST', body, credentials:'omit',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8', 'Accept':'application/json' }
    });
    const json = await res.json().catch(()=>({}));
    if(json && json.ok){
      showToast('送信しました！');
      submitBtn.disabled = true; studentIdInput.disabled = true; studentNameInput.disabled = true;
      setTimeout(loadLeaderboard, 4000);
    }else{
      const msg = ({
        'INVALID_STUDENT_ID':'学籍番号が正しくありません',
        'EMPTY_NAME':'氏名を入力してください',
        'INVALID_TICKETS':'提出データが不正です',
        'RULE_VERSION_MISMATCH':'バージョンが異なります（再読み込みしてください）',
        'BAD_TICKET':'改ざん検出（再読み込みしてやり直してください）',
        'SCORE_BELOW_THRESHOLD':'10点未満は提出できません',
        'SESSION_EXPIRED':'セッション期限切れ（再読み込みしてください）',
      })[json.error] || '送信に失敗しました…';
      showToast(msg); submitBtn.disabled=false;
    }
  }catch(e){
    console.error(e); showToast('送信に失敗しました…'); submitBtn.disabled=false;
  }
}
submitBtn.addEventListener('click', submitResult);

/* ローカル採点（UI同期用/提出はサーバ基準） */
function localServerLikeTotal(items){
  const G=RULE.g, VMIN=RULE.vMin, VMAX=RULE.vMax;
  const PERIOD_MS = (Number(session.phiSec)||RULE.cycleSec)*1000;
  let total=0;
  for(const t of items){
    const type=t.type, target=Number(t.target);
    let v0 = Number(t.v0);
    if (!Number.isFinite(v0)){
      const unit = (((Number(t.tClickAdj)-Number(t.t0Ms)) / (Number(t.phiSec)*1000))%1 + 1)%1;
      v0 = VMIN + unit*(VMAX-VMIN);
    }
    const H = (v0*v0)/(2*G);
    const T = 2*v0/G;
    const value = (type==='H') ? H : T;
    const errPct = Math.abs(value - target)/target;
    let gained=0;
    for(const b of RULE.scoreBands){ if (errPct < b.lt){ gained=b.pts; break; } }
    total += gained;
  }
  return { total };
}

/* ========= ランキング読み込み（CSV） ========= */
async function loadLeaderboard(){
  const desktopBox = document.getElementById('leaderboard');
  const mobileBox  = document.getElementById('leaderboardMobile');
  if (!desktopBox && !mobileBox) return;
  try{
    const url = CSV_URL + (CSV_URL.includes('?') ? '&':'?') + 'cb=' + Date.now();
    const res = await fetch(url, { credentials:'omit', cache:'no-store' });
    const text = await res.text();
    const { cols, rows } = parseCSV(text);
    renderFromRows(cols, rows);
  }catch(e){ console.error(e); const msg='ランキングを読み込めませんでした…'; if(desktopBox) desktopBox.textContent=msg; if(mobileBox) mobileBox.textContent=msg; }

  function renderFromRows(cols, rows){
    const idx = {
      timestamp: findIndex(cols,/time|タイムスタンプ|timestamp/i,0),
      studentId: findIndex(cols,/番号|学籍|id/i,1),
      studentName: findIndex(cols,/氏名|名前|name/i,2),
      totalScore: findIndex(cols,/score|スコア|合計|点/i,3)
    };
    let recs = rows.map(r=>({
      timestamp:String(r[idx.timestamp]??''), id:String(r[idx.studentId]??'').trim(),
      name:String(r[idx.studentName]??'').trim(),
      score:Number(String(r[idx.totalScore]??'').replace(/[^\d.-]/g,''))
    }));
    recs = recs.filter(x=>Number.isFinite(x.score) && x.score>=10);
    recs = bestByKey(recs, x=>x.id||x.name);
    recs.sort((a,b)=> b.score-a.score || (new Date(b.timestamp)-new Date(a.timestamp)));
    recs = recs.slice(0,20);
    const html = renderTableHTML(recs);
    if(desktopBox) desktopBox.innerHTML=html; if(mobileBox) mobileBox.innerHTML=html;
  }
  function parseCSV(text){ const rows=[]; let cur=[],field='',inQ=false;
    for(let i=0;i<text.length;i++){ const ch=text[i],next=text[i+1];
      if(inQ){ if(ch==='"'&&next==='"'){field+='"'; i++;} else if(ch==='"'){inQ=false;} else {field+=ch;} }
      else { if(ch==='"'){inQ=true;} else if(ch===','){cur.push(field); field='';}
             else if(ch==='\n'){cur.push(field); rows.push(cur); cur=[]; field='';}
             else if(ch==='\r'){} else {field+=ch;} } }
    if(field.length||cur.length){cur.push(field); rows.push(cur);} const cols=rows.shift()||[]; return{cols,rows}; }
  function findIndex(arr,regex,fallback=-1){ const i=arr.findIndex(h=>regex.test(String(h))); return i>=0?i:fallback; }
  function bestByKey(list,keyFn){ const best=new Map(); for(const r of list){ const k=keyFn(r); if(!k) continue; const cur=best.get(k); if(!cur||r.score>cur.score) best.set(k,r);} return Array.from(best.values()); }
  function renderTableHTML(items){
    if(!items.length) return 'まだランキングはありません。';
    const left=items.slice(0,10), right=items.slice(10,20);
    const rows=Array.from({length:10},(_,i)=>({L:left[i]||{name:'',id:'',score:''},R:right[i]||{name:'',id:'',score:''}}));
    return `
    <table style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:14px; margin-bottom:8px">
      <colgroup>
        <col style="width:7%"><col style="width:33%"><col style="width:12%"><col style="width:18%">
        <col style="width:4%">
        <col style="width:7%"><col style="width:33%"><col style="width:12%"><col style="width:18%">
      </colgroup>
      <thead>
        <tr>
          <th style="text-align:center; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">位</th>
          <th style="text-align:left;   padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">氏名</th>
          <th style="text-align:center; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">番号</th>
          <th style="text-align:right;  padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">スコア</th>
          <th></th>
          <th style="text-align:center; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">位</th>
          <th style="text-align:left;   padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">氏名</th>
          <th style="text-align:center; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">番号</th>
          <th style="text-align:right;  padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">スコア</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map((r,i)=>`
          <tr>
            <td style="text-align:center; font-weight:700; font-variant-numeric: tabular-nums">${i+1}</td>
            <td style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${escapeHTML(r.L.name || '—')}</td>
            <td style="text-align:center; font-variant-numeric: tabular-nums">${escapeHTML(r.L.id || '—')}</td>
            <td style="text-align:right;  font-variant-numeric: tabular-nums">${r.L.score ?? ''}</td>
            <td></td>
            <td style="text-align:center; font-weight:700; font-variant-numeric: tabular-nums">${i+11}</td>
            <td style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap">${escapeHTML(r.R.name || '—')}</td>
            <td style="text-align:center; font-variant-numeric: tabular-nums">${escapeHTML(r.R.id || '—')}</td>
            <td style="text-align:right;  font-variant-numeric: tabular-nums">${r.R.score ?? ''}</td>
          </tr>`).join('')}
      </tbody>
    </table>`;
  }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
}

/* ========= リサイズ対応 ========= */
function handleResize(){ fitSceneToViewport(); renderGrid(); hLine.style.bottom=groundOffsetPx+'px'; ball.style.bottom=groundOffsetPx+'px'; }
window.addEventListener('resize', handleResize);
window.addEventListener('orientationchange', ()=>setTimeout(handleResize,200));
if(window.visualViewport){ window.visualViewport.addEventListener('resize', ()=>setTimeout(handleResize,50)); }

/* ========= 初期化 ========= */
(async function init(){
  await fetchSession();
  requestAnimationFrame(rouletteLoop);
  await setupRound();
  loadLeaderboard();
  setInterval(loadLeaderboard, 60000);
})();
})();
</script>
</body>
</html>
