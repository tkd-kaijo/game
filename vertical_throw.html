<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>鉛直投げ上げゲーム〜5球で10点取れ！〜</title>
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --accent:#6ae3ff; --accent2:#8effa1; --text:#e8edf2; --muted:#9aa7b3;
    --ok:#8effa1; --ng:#ff9aa8; --yellow:#ffd36a;
  }
  *{box-sizing:border-box}
  html, body{height:100%;}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif;
    background: radial-gradient(1200px 600px at 70% -10%, #1a1f38, #0b0e1a 60%), var(--bg);
    color:var(--text); display:flex; min-height:100svh; align-items:center; justify-content:center; padding:16px;
  }
  @supports (min-height: 100dvh){ body{ min-height:100dvh; } }

  .app{width:min(980px,100%); display:grid; gap:12px}
  .title{font-weight:700; letter-spacing:.02em; font-size:clamp(18px,3vw,28px); text-align:center}

  /* 課題＆スコア（タイトル直下） */
  .challengeBox{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;
    padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
  }
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:14px; background:rgba(255,255,255,.08); color:var(--yellow)}
  #challengeTextHUD{font-weight:700}
  #scoreHUD{font-variant-numeric: tabular-nums; font-weight:900}
  .great{color:#a7ff6a; font-weight:800; margin-left:8px}
  .good{color:var(--ok); font-weight:800; margin-left:8px}
  .ok{color:#ffd36a; font-weight:800; margin-left:8px}
  .bad{color:#ff9aa8; font-weight:800; margin-left:8px}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.00));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
  }

  /* ルーレット */
  .roulette{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center}
  .bar{
    height:16px; background:#111528; border-radius:999px; overflow:hidden; position:relative;
    border:1px solid rgba(255,255,255,.08);
  }
  .fill{
    height:100%; width:0%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width .06s linear;
    box-shadow: 0 0 10px rgba(106,227,255,.6), inset 0 0 8px rgba(0,0,0,.3);
  }
  .speed{font-variant-numeric: tabular-nums; font-weight:800; letter-spacing:.02em; min-width:8ch; text-align:right; font-size:18px}

  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:center}
  button {
  appearance:none; border:none; border-radius:12px;
  padding:14px 20px;             /* ←ちょっと広めに */
  font-weight:700; cursor:pointer;
  font-size: clamp(22px, 3.8vw, 34px);  /* ←速さ表示に合わせる */
  color:#03131a;
  background:linear-gradient(180deg, #8ff2ff, #6ae3ff);
  box-shadow: 0 8px 22px rgba(106,227,255,.35), inset 0 1px 0 rgba(255,255,255,.6);
}

@media (min-width: 820px) {
  button {
    font-size: clamp(34px, 3.8vw, 53px);
    padding: 18px 28px;
  }
}
  button.secondary{
    background:linear-gradient(180deg, #d7e7ff, #b8cfff);
    box-shadow: 0 8px 22px rgba(184,207,255,.28), inset 0 1px 0 rgba(255,255,255,.6);
  }
  button:disabled{opacity:.5; cursor:not-allowed}

  /* プレイ領域レイアウト */
  .playgrid{display:grid; grid-template-columns: 1fr; gap:10px; align-items:start}
  @media (orientation: portrait){
    .playgrid{grid-template-columns: 1fr 1fr; grid-template-areas: 'scene readouts';}
    .scene{grid-area: scene}
    .readouts{grid-area: readouts}
  }
  @media (orientation: landscape){
    .playgrid{grid-template-columns: 1fr 1fr; grid-template-areas: 'scene readouts';}
    .scene{grid-area: scene}
    .readouts{grid-area: readouts}
  }

  /* アニメーション領域（高さはJSでフィット） */
  .scene{
    position:relative; height:420px; border-radius:14px; overflow:hidden; margin-top:10px;
    background:
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)),
      radial-gradient(800px 260px at 50% 0%, rgba(106,227,255,.08), rgba(0,0,0,0) 60%),
      #0b1022;
    border:1px solid rgba(255,255,255,.08);
  }
  .ground{position:absolute; inset:auto 0 0 0; height:8px; background:#1a2039; box-shadow: 0 -2px 0 rgba(255,255,255,.06) inset}

  /* 10m刻みグリッド */
  .grid{position:absolute; inset:0 0 8px 0; pointer-events:none;}
  .gridline{position:absolute; left:8px; right:8px; height:1px; background:rgba(255,255,255,.22); opacity:.7}
  .gridlabel{position:absolute; right:10px; transform:translateY(-50%); font-size:11px; color:var(--muted); background:rgba(0,0,0,.35); padding:1px 6px; border-radius:999px; border:1px solid rgba(255,255,255,.12)}

  /* 最高到達高度ライン（赤） */
  .hline{position:absolute; left:8px; right:8px; height:2px; background:#ff5b5b; box-shadow:0 0 8px rgba(255,91,91,.6);}

  .ball{
    position:absolute; left:50%; transform:translateX(-50%); /* ←下端基準にするため縦方向の変換は無し */
    width:18px; aspect-ratio:1; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff, #bfeaff 30%, #6ae3ff 45%, #0aa3c0 70%, #067089 100%);
    box-shadow: 0 8px 24px rgba(106,227,255,.45);
  }
  .meter{position:absolute; right:10px; top:10px; font-size:12px; color:var(--muted);
    background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); padding:6px 8px; border-radius:8px; z-index:1}

  /* 右側の連続表示 */
  .readouts{display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:10px}
  @media (max-width: 980px){ .readouts{grid-template-columns:1fr 1fr} }
  @media (orientation: portrait){ .readouts{grid-template-columns:1fr; align-content:start} }
  .stat{background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px}
  .stat .label{color:var(--muted); font-size:12px; letter-spacing:.02em}
  .stat .value{font-variant-numeric: tabular-nums; font-weight:800; font-size:22px}

  /* ====== デスクトップ/iPad用の強調（+20%） ====== */
  @media (min-width: 820px) {
    .title{ font-size: clamp(24px, 2.6vw, 36px); }
    .challengeBox{ padding:12px 16px; gap:16px; }
    .badge{ font-size: 26px; padding:8px 18px; }
    #challengeTextHUD{ font-size: clamp(31px, 2.9vw, 43px); }
    #scoreHUD{ font-size: clamp(43px, 3.8vw, 53px); }
    .speed{ font-size: clamp(43px, 3.8vw, 53px); }
    .bar{ height: 22px; }
    .stat .label{ font-size: 16px; }
    .stat .value{ font-size: clamp(30px, 2.6vw, 40px); }
  }

  /* iPad横向き微調整 */
  @media (orientation: landscape) and (min-width: 768px) and (max-width: 1180px) {
    .title{ font-size: 20px; }
    #challengeTextHUD{ font-size: 28px; }
    #scoreHUD, .speed{ font-size: 34px; }
    .stat .value{ font-size: 24px; }
    .stat .label{ font-size: 14px; }
    .bar{ height: 18px; }
  }

  /* 常に赤字に固定 */
  #challengeTextHUD, .speed { color:#ff5b5b !important; }

  /* 提出フォーム */
  .submitBox{ display:none; margin-top:12px; padding:12px; border:1px solid rgba(255,255,255,.12); border-radius:12px; background:rgba(255,255,255,.06); }
  .submitBox h3{ margin:0 0 8px 0; font-size:16px; }
  .submitRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .submitRow input[type="text"]{ flex:1; min-width:180px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#0f1430; color:#fff; font-size:16px; }
  .submitRow button{ padding:10px 14px; border-radius:10px; border:none; font-weight:700; cursor:pointer; color:#03131a; background:linear-gradient(180deg, #b1ffd1, #7affaf); box-shadow: 0 8px 22px rgba(122,255,175,.28); }
  .helpText{ font-size:12px; color:#cfe3ff; opacity:.9; margin-top:6px; }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#0b1022; color:#eafff3; padding:10px 14px; border:1px solid rgba(255,255,255,.1); border-radius:10px; display:none; z-index:9999}
</style>
</head>
<body>
  <main class="app">
    <div class="title">鉛直投げ上げゲーム〜5球で10点取れ！〜</div>

    <!-- 課題＆スコア -->
    <div class="challengeBox" id="challengeBox">
      <span class="badge" id="roundBadgeHUD">ラウンド1/5</span>
      <span id="challengeTextHUD">—</span>
      <span id="resultTextHUD"></span>
      <span>｜スコア <strong id="scoreHUD">0点</strong></span>
    </div>

    <section class="card" id="card">
      <!-- ルーレット -->
      <div class="roulette" aria-live="polite">
        <div class="bar" aria-label="初速ルーレット（0〜35 m/s を4.5秒で周回）">
          <div class="fill" id="fill"></div>
        </div>
        <div class="speed" id="speedLabel">0.00 m/s</div>
      </div>
      <div class="actions">
        <button id="lockBtn">投射！</button>
        <button id="retryBtn" class="secondary" disabled>次のラウンド</button>
        <button id="resetBtn" class="secondary" style="display:none">もう一度</button>
      </div>

      <div class="playgrid">
        <!-- アニメーション領域 -->
        <div class="scene" id="scene">
          <div class="meter">g = 9.8 m/s²</div>
          <div class="grid" id="grid"></div>
          <div class="hline" id="hline" style="bottom:8px;"></div>
          <div class="ball" id="ball" style="bottom:8px"></div>
          <div class="ground"></div>
        </div>

        <!-- 右側の数値表示 -->
        <div class="readouts" id="readouts">
          <div class="stat"><div class="label">現在の高さ y</div><div class="value" id="yNow">0.00 m</div></div>
          <div class="stat"><div class="label">最高到達高度 H</div><div class="value" id="hVal">0.00 m</div></div>
          <div class="stat"><div class="label">時間t</div><div class="value" id="tVal">0.00 s</div></div>
        </div>
      </div>

      <section class="card" id="leaderboardCard" aria-live="polite">
  <h3 style="margin:0 0 8px">ランキング（上位10）</h3>
  <div id="leaderboard">読み込み中…</div>
</section>
      
    </section>
  </main>

  <!-- 提出フォーム（最後に表示） -->
  <div class="submitBox" id="submitBox" style="display:none" aria-live="polite">
    <h3>提出</h3>
    <div class="submitRow">
      <label for="studentId">4桁番号(年組番)：</label>
      <input id="studentId" type="text" placeholder="3143" inputmode="numeric" />
    </div>
    <div class="submitRow">
      <label for="studentName">氏名：</label>
      <input id="studentName" type="text" placeholder="海城太郎" />
      <button id="submitBtn">送信</button>
    </div>
    <div class="helpText" id="submitHelp">5回分の合計点と一緒に提出されます。</div>
  </div>
  <div class="toast" id="toast"></div>

<script>
(() => {
  const g = 9.8;
  const vMin=0,vMax=35,cycleSec=4.5;

  // DOM
  const fillEl=document.getElementById('fill');
  const speedLabel=document.getElementById('speedLabel');
  const lockBtn=document.getElementById('lockBtn');
  const retryBtn=document.getElementById('retryBtn');
  const resetBtn=document.getElementById('resetBtn');
  const scene=document.getElementById('scene');
  const gridEl=document.getElementById('grid');
  const hLine=document.getElementById('hline');
  const ball=document.getElementById('ball');
  const yNowEl=document.getElementById('yNow');
  const hValEl=document.getElementById('hVal');
  const tValEl=document.getElementById('tVal');
  const roundBadgeHUD=document.getElementById('roundBadgeHUD');
  const challengeTextHUD=document.getElementById('challengeTextHUD');
  const resultTextHUD=document.getElementById('resultTextHUD');
  const scoreHUD=document.getElementById('scoreHUD');

  /* Googleフォーム設定 */
  const CONFIG = {
    SUBMIT_MODE: 'google_forms',
    GOOGLE_FORMS: {
      url: 'https://docs.google.com/forms/d/e/1FAIpQLSdclzAB4YrLDhGSKkAoOC4IzF91eYF0uaWZuzXnJkZvBXGC7Q/formResponse',
      entry: {
        studentId: 'entry.196095964',
        studentName: 'entry.914895046',
        totalScore: 'entry.1303752079',
        timestamp: 'entry.1852796806'
      }
    }
  };


// === Leaderboard settings ===
// ★ここを自分のシートIDとシート名に差し替えてください
const SHEET_ID = '16PFWfElWUfN3x7iV4fSOnw0y3IdQBtrJIVzg6yOmLoU';
const SHEET_GID = '1244360108'; // 数字

  

// Google Visualization API (gviz) のJSONを叩いて成績取得
// 共有が「リンク閲覧可」ならCORS越しでもフロントから読めます
async function loadLeaderboard () {
  const box = document.getElementById('leaderboard');
  if (!box) return;

 // 追加
const SHEET_NAME = 'Submissions';

// 置き換え（gidではなくsheet=を使う）
const gvizUrl =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;

  
  try {
    const res = await fetch(gvizUrl, { credentials: 'omit' });
    const text = await res.text();

    // HTML（ログインページ等）を引いたら失敗扱い
    if (/^\s*</.test(text)) throw new Error('Got HTML');

    // gviz のラッパを剥がす
    const json = JSON.parse(text.replace(/^[^{]+/, '').replace(/;?\s*$/, ''));
    const cols = (json.table.cols || []).map(c => (c && c.label) ? c.label : '');
    const rows = (json.table.rows || []).map(r => (r.c || []).map(c => c ? c.v : ''));

    renderFromRows(cols, rows);
    return;
  } catch (e) {
    console.warn('gviz failed:', e);
  }

  // フォールバック：CSV（[ウェブに公開] 有効時）
 const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ10LcB0wupR7ip5mhf_WskxAZiQQIXytBQ45Sxyf2ej9R1xULe-iQbj7RU2TgNXOrjTrUVefFQOEIO/pub?output=csv";
  
  try {
    const res = await fetch(csvUrl, { credentials: 'omit' });
    const text = await res.text();
    const { cols, rows } = parseCSV(text);
    renderFromRows(cols, rows);
  } catch (e) {
    console.error(e);
    box.textContent = 'ランキングを読み込めませんでした…';
  }

  function renderFromRows (cols, rows) {
    // 見出しの自動当て
    const idx = {
      timestamp: findIndex(cols, /time|タイムスタンプ|timestamp/i, 0),
      studentId: findIndex(cols, /番号|学籍|id/i),
      studentName: findIndex(cols, /氏名|名前|name/i),
      totalScore: findIndex(cols, /score|スコア|合計|点/i)
    };

    let recs = rows.map(r => ({
      timestamp: String(r[idx.timestamp] ?? ''),
      id: String(r[idx.studentId] ?? '').trim(),
      name: String(r[idx.studentName] ?? '').trim(),
      score: Number(String(r[idx.totalScore] ?? '').replace(/[^\d.-]/g, ''))
    }));

    // 10点未満は除外
    recs = recs.filter(x => Number.isFinite(x.score) && x.score >= 10);

    // 同一ID（なければ氏名）で最高点のみ
    recs = bestByKey(recs, x => x.id || x.name);

    // スコア降順、同点は新しい順（gviz の "Date(YYYY,MM,DD,...)" を解釈）
    recs.sort((a, b) =>
      b.score - a.score || (parseGvizDate(b.timestamp) - parseGvizDate(a.timestamp))
    );

    recs = recs.slice(0, 10);
    box.innerHTML = renderTableHTML(recs);
  }

  function parseCSV (text) {
    const rows = [];
    let cur = [], field = '', inQ = false;
    for (let i = 0; i < text.length; i++) {
      const ch = text[i], next = text[i+1];
      if (inQ) {
        if (ch === '"' && next === '"') { field += '"'; i++; }
        else if (ch === '"') { inQ = false; }
        else { field += ch; }
      } else {
        if (ch === '"') inQ = true;
        else if (ch === ',') { cur.push(field); field = ''; }
        else if (ch === '\n') { cur.push(field); rows.push(cur); cur = []; field = ''; }
        else if (ch === '\r') { /* ignore */ }
        else { field += ch; }
      }
    }
    if (field.length || cur.length) { cur.push(field); rows.push(cur); }
    const cols = rows.shift() || [];
    return { cols, rows };
  }

  function findIndex (arr, regex, fallback = -1) {
    const i = arr.findIndex(h => regex.test(String(h)));
    return i >= 0 ? i : fallback;
  }

  function bestByKey (list, keyFn) {
    const best = new Map();
    for (const r of list) {
      const k = keyFn(r);
      if (!k) continue;
      const cur = best.get(k);
      if (!cur || r.score > cur.score) best.set(k, r);
    }
    return Array.from(best.values());
  }

  // "Date(2025,8,3,15,29,31)" → Date
  function parseGvizDate (v) {
    if (v instanceof Date) return v;
    const m = String(v).match(/Date\((\d+),(\d+),(\d+),(\d+),(\d+),(\d+)\)/);
    if (m) {
      const [ , Y, M, D, h, m2, s ] = m.map(Number);
      return new Date(Y, M, D, h, m2, s);
    }
    // フォールバック：通常のDateパース
    const d = new Date(v);
    return isNaN(d) ? new Date(0) : d;
  }

  function renderTableHTML (items) {
    if (!items.length) return 'まだランキングはありません。';
    const rows = items.map((r, i) => `
      <tr>
        <td style="text-align:center; font-weight:700">${i+1}</td>
        <td>${escapeHTML(r.name || '—')}</td>
        <td style="text-align:center">${escapeHTML(r.id || '—')}</td>
        <td style="text-align:right; font-variant-numeric: tabular-nums">${r.score}</td>
      </tr>`).join('');
    return `
      <div style="overflow:auto">
      <table style="width:100%; border-collapse:collapse; font-size:14px">
        <thead>
          <tr>
            <th style="text-align:center; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">位</th>
            <th style="text-align:left;   padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">氏名</th>
            <th style="text-align:center; padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">番号</th>
            <th style="text-align:right;  padding:6px 8px; border-bottom:1px solid rgba(255,255,255,.12)">スコア</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      </div>`;
  }

  function escapeHTML (s) {
    return String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }
}

  
  const submitBox = document.getElementById('submitBox');
  const submitBtn = document.getElementById('submitBtn');
  const studentIdInput = document.getElementById('studentId');
  const studentNameInput = document.getElementById('studentName');
  const toast = document.getElementById('toast');
  document.getElementById('submitHelp').textContent = '10点以上で提出できます。';

  function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 2000); }
  function showSubmitBox(){ submitBox.style.display='block'; studentIdInput.focus(); }


const GAS_URL = 'https://script.google.com/macros/s/AKfycbyX_AoSMfB5trdWttsbay8UjkOCH0rVxOxgI2mJOJhF84A-N9hV0LkqO4vYCTfwMfDr/exec';

async function submitResult(){
  if (score < 10) {
    showToast('スコアが10点未満のため提出できません');
    return;
  }
  const studentId = studentIdInput.value.trim();
  const studentName = studentNameInput.value.trim();
  if(!/^\d{4}$/.test(studentId) || !studentName){
    showToast('4桁番号と氏名を入力してください');
    return;
  }
  try{
    const payload = {
      studentId,
      studentName,
      totalScore: score,
      timestamp: new Date().toISOString() // 任意（記録用）
    };
    const params = new URLSearchParams({
  studentId,
  studentName,
  totalScore: String(score)
  // timestamp はサーバ側で付与しているので不要
});
const res = await fetch(GAS_URL, {
  method: 'POST',
  body: params   // ← ヘッダは付けない（ブラウザが適切に付ける）
});
const json = await res.json().catch(()=>({}));

    if(json.ok){
      showToast('送信しました！');
      submitBtn.disabled = true;
      studentIdInput.disabled = true;
      studentNameInput.disabled = true;

      // （ランキングを公開用シートから読んでいる場合）少し後に再読込
      setTimeout(loadLeaderboard, 4000);
    }else{
      console.warn('GAS rejected:', json);
      const msg = ({
        'INVALID_STUDENT_ID':'学籍番号が正しくありません',
        'EMPTY_NAME':'氏名を入力してください',
        'INVALID_SCORE':'スコアが不正です',
        'SCORE_BELOW_THRESHOLD':'10点未満は提出できません',
        'RATE_LIMIT':'連投が早すぎます。少し待って再送してください',
      })[json.error] || '送信に失敗しました…';
      showToast(msg);
    }
  }catch(e){
    console.error(e);
    showToast('送信に失敗しました…');
  }
}

  
  if(submitBtn){ submitBtn.addEventListener('click', submitResult); }

  // レイアウト関連
  const groundOffsetPx=8; // 地面の線（.ground）の厚み分
let currentScale = null;   // ★いま使う px/m を保持
  const sceneHeight=()=>scene.clientHeight-groundOffsetPx;
  function scalePxPerMeterFor(v0){
    const H=(v0*v0)/(2*g);
    const maxPx=sceneHeight()-26;
    const base=8;
    return Math.min(base,maxPx/Math.max(H,1e-6));
  }
  function scalePxPerMeterForMaxMeters(maxMeters){
    const maxPx=sceneHeight()-26;
    return Math.max(0.5, maxPx/Math.max(maxMeters,1e-6));
  }

  // ビューポートフィット
  let baselineTop = null;
  function getVH(){
    const vvh = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
    return Math.min(window.innerHeight, vvh);
  }
  function fitSceneToViewport(){
    const vh = getVH();
    if(baselineTop === null){ baselineTop = scene.getBoundingClientRect().top; }
    const margin = 12;
    let desired = Math.floor(vh - baselineTop - margin);
    desired = Math.max(220, Math.min(desired, vh - margin));
    const prev = parseFloat(getComputedStyle(scene).height);
    if(!isNaN(prev) && Math.abs(prev - desired) < 2){ return; }
    scene.style.height = desired + 'px';

// ★このタイミングで1回だけスケールを計算して保持
currentScale = scalePxPerMeterForMaxMeters(60);

// ★保持スケールで描画
renderGrid(); 
hLine.style.bottom = groundOffsetPx + 'px';
  }

  // グリッド描画（0〜60m）
 function renderGrid(scale){
  // ★引数が無ければ currentScale を使う
  const s = (typeof scale === 'number') ? scale : currentScale;

  gridEl.innerHTML = '';
  const marks = [0,10,20,30,40,50,60];
  const hGrid = gridEl.clientHeight;

  for (const m of marks) {
    const bottom = m * s;   // ★s を使用
    if (bottom < 0 || bottom > hGrid - 2) continue;

    const line = document.createElement('div');
    line.className = 'gridline';
    line.style.bottom = bottom + 'px';
    gridEl.appendChild(line);

    const lab = document.createElement('div');
    lab.className = 'gridlabel';
    lab.style.bottom = bottom + 'px';
    lab.textContent = m + ' m';
    gridEl.appendChild(lab);
  }
}

  // ゲーム進行
  const maxRounds=5; let round=1; let score=0; let lastGainedPoints=0;
  const Xs=[4.9,19.6,44.1]; const Ts=[1,2,3,4,6];
  let challenge=null; let prevChallenge=null;

  function pickChallenge(){
    let newC;
    do {
      if(Math.random()<0.5){
        const x=Xs[Math.floor(Math.random()*Xs.length)];
        newC={type:'H',target:x,text:`最高到達高度 ${x} m を目指せ！`};
      }else{
        const t=Ts[Math.floor(Math.random()*Ts.length)];
        newC={type:'T',target:t,text:`着地時間 ${t} 秒 を目指せ！`};
      }
    } while(prevChallenge && newC.type===prevChallenge.type && newC.target===prevChallenge.target);
    challenge=newC; prevChallenge=newC;
    challengeTextHUD.textContent=newC.text;
    resultTextHUD.textContent='';
    roundBadgeHUD.textContent = `ラウンド${round}/${5}`;
  }

  // サウンド
  let audioCtx=null;
  function beep(freq=880,duration=0.15,type='sine',gain=0.08){
    try{
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const t0=audioCtx.currentTime;
      const osc=audioCtx.createOscillator();
      const gnode=audioCtx.createGain();
      osc.type=type; osc.frequency.value=freq; gnode.gain.value=gain;
      osc.connect(gnode).connect(audioCtx.destination);
      osc.start(t0);
      gnode.gain.setValueAtTime(gain,t0);
      gnode.gain.exponentialRampToValueAtTime(0.0001,t0+duration);
      osc.stop(t0+duration+0.02);
    }catch(e){}
  }
  const okSound = ()=>beep(740,0.12);
  const goodSound = ()=>{beep(880,0.12); setTimeout(()=>beep(1175,0.12),120);};
  const greatSound= ()=>{beep(1047,0.10); setTimeout(()=>beep(1319,0.10),110); setTimeout(()=>beep(1661,0.14),230);};
  const wrongSound= ()=>{beep(220,0.25,'square',0.06); setTimeout(()=>beep(175,0.25,'square',0.05),120);};

  // ルーレット
  let running=true; let locked=false; let t0Roulette=performance.now();
  function rouletteLoop(now){
    if(!running)return;
    const elapsed=(now-t0Roulette)/1000;
    const v=vMin+((elapsed%cycleSec)/cycleSec)*(vMax-vMin);
    updateSpeedUI(v);
    requestAnimationFrame(rouletteLoop);
  }
  function updateSpeedUI(v){
    const c=Math.max(vMin,Math.min(vMax,v));
    const ratio=(c-vMin)/(vMax-vMin);
    fillEl.style.width=(ratio*100).toFixed(2)+'%';
    speedLabel.textContent=c.toFixed(2)+' m/s';
  }

  // アニメーション（下端基準）
  function animateThrow(v0){
    const scale = currentScale;  // ★保持スケールを使用
renderGrid();                // ★引数なし
    const T=2*v0/g; const H=(v0*v0)/(2*g);
    const tPeak = v0/g;
    const start=performance.now();

    function step(now){
      const t=(now-start)/1000;
      const tC=Math.max(0,Math.min(T,t));
      
      const y = Math.max(0, v0*tC - 0.5*g*tC*tC);   // 下端の高さ[m]
    ball.style.bottom = (groundOffsetPx + y*scale) + 'px';

      // 赤線：上昇中は下端(y)、以降は最高到達高度(H)
      const hDisp = (tC <= tPeak) ? y : H;
      hLine.style.bottom = (groundOffsetPx + hDisp*scale) + 'px';

      // 右側表示（Hは頂点到達までは更新し続け、以降固定）
      yNowEl.textContent=y.toFixed(2)+' m';
      hValEl.textContent = ((tC <= tPeak) ? y : H).toFixed(2) + ' m';
      tValEl.textContent=tC.toFixed(2)+' s';

      if(t<T-1e-3){
        requestAnimationFrame(step);
      }else{
        ball.style.bottom=groundOffsetPx+'px';
        yNowEl.textContent='0.00 m'; hValEl.textContent=H.toFixed(2)+' m'; tValEl.textContent=T.toFixed(2)+' s';
        hLine.style.bottom = (groundOffsetPx + H*scale) + 'px';
        evaluateAndProceed(H,T);
      }
    }
    requestAnimationFrame(step);
  }

  // 採点：<10%:3点 / 10–20%:2点 / 20–30%:1点
  function evaluateAndProceed(H,T){
    const errPct = (challenge.type==='H')
      ? Math.abs(H - challenge.target) / challenge.target
      : Math.abs(T - challenge.target) / challenge.target;

    let gained = 0;
    if(errPct < 0.10){ gained=3; score+=3; resultTextHUD.innerHTML = `<span class="great">great!!（誤差 ${(errPct*100).toFixed(1)}% / +${gained}点）</span>`; greatSound(); }
    else if(errPct < 0.20){ gained=2; score+=2; resultTextHUD.innerHTML = `<span class="good">good!（誤差 ${(errPct*100).toFixed(1)}% / +${gained}点）</span>`; goodSound(); }
    else if(errPct < 0.30){ gained=1; score+=1; resultTextHUD.innerHTML = `<span class="ok">ok（誤差 ${(errPct*100).toFixed(1)}% / +${gained}点）</span>`; okSound(); }
    else { resultTextHUD.innerHTML = `<span class="bad">miss…（誤差 ${(errPct*100).toFixed(1)}%）</span>`; wrongSound(); }

    scoreHUD.textContent = String(score) + '点';
    lastGainedPoints = gained;
    lockBtn.disabled=true; retryBtn.disabled=false;

    if(round>=maxRounds){
  const finalMsg = (score >= 10) ? '課題クリア！' : '10点目指してもう1度頑張ろう！';
  resultTextHUD.innerHTML =
    `<div>5回目の得点：<strong>+${lastGainedPoints}点</strong></div>` +
    `<div>全${maxRounds}回の合計スコア：<strong>${score}点</strong></div>`;
  challengeTextHUD.textContent = finalMsg;
  retryBtn.style.display='none';
  resetBtn.style.display='inline-block';

  // ★ 10点以上だけ提出可
  if (score >= 10) {
    showSubmitBox();
  } else {
    submitBox.style.display = 'none'; // 念のため隠す
    showToast('今回はスコアが10点未満のため提出できません');
  }
}
  }

  function setupNextRound(){
    if(round<maxRounds){ round += 1; }
    pickChallenge(); locked=false; running=true; t0Roulette=performance.now();
    lockBtn.disabled=false; retryBtn.disabled=true; ball.style.bottom=groundOffsetPx+'px';
    yNowEl.textContent='0.00 m'; hValEl.textContent='0.00 m'; tValEl.textContent='0.00 s';
    renderGrid();                       // ★保持スケール
hLine.style.bottom = groundOffsetPx + 'px';
    requestAnimationFrame(rouletteLoop);
    fitSceneToViewport();
  }

  function resetGame(){
    round = 1; score = 0; lastGainedPoints = 0; scoreHUD.textContent='0点';
    retryBtn.style.display='inline-block'; resetBtn.style.display='none';
    submitBox.style.display='none'; submitBtn.disabled=false; studentIdInput.disabled=false; studentNameInput.disabled=false;
    studentIdInput.value=''; studentNameInput.value='';
    pickChallenge(); locked=false; running=true; t0Roulette=performance.now();
    lockBtn.disabled=false; retryBtn.disabled=true; ball.style.bottom=groundOffsetPx+'px';
    yNowEl.textContent='0.00 m'; hValEl.textContent='0.00 m'; tValEl.textContent='0.00 s';
    roundBadgeHUD.textContent = `ラウンド${round}/${5}`;
    currentScale = scalePxPerMeterForMaxMeters(60); // ★再計算はリセット時だけ
renderGrid();
hLine.style.bottom = groundOffsetPx + 'px';
    requestAnimationFrame(rouletteLoop);
    fitSceneToViewport();
    window.scrollTo({top:0, behavior:'instant'});
  }

  lockBtn.addEventListener('click',()=>{
    if(locked)return; locked=true; running=false;
    const v=parseFloat(speedLabel.textContent.replace(' m/s',''));
    lockBtn.disabled=true; retryBtn.disabled=true; animateThrow(v);
  });
  retryBtn.addEventListener('click',()=>{setupNextRound();});
  resetBtn.addEventListener('click',()=>{resetGame();});
  submitBtn.addEventListener('click', submitResult);

  // 初期化
  requestAnimationFrame(rouletteLoop);
  pickChallenge();
  renderGrid(scalePxPerMeterForMaxMeters(60));  
  currentScale = scalePxPerMeterForMaxMeters(60);
  hLine.style.bottom = groundOffsetPx + 'px';
  ball.style.bottom = groundOffsetPx + 'px';

  // レイアウトフィット
  function bindFit(){
    baselineTop = scene.getBoundingClientRect().top;
    fitSceneToViewport();
    window.addEventListener('resize', ()=>{ baselineTop=null; fitSceneToViewport(); });
    window.addEventListener('orientationchange', ()=>setTimeout(()=>{
      baselineTop=null; fitSceneToViewport(); window.scrollTo({top:0, behavior:'instant'});
    }, 200));
    if(window.visualViewport){
      window.visualViewport.addEventListener('resize', ()=>{ baselineTop=null; fitSceneToViewport(); });
    }
  }
  // 初回読み込み＆60秒ごとに更新
loadLeaderboard();
setInterval(loadLeaderboard, 60000);

  
  if(document.readyState === 'complete' || document.readyState === 'interactive'){
    setTimeout(bindFit, 50);
  }else{
    window.addEventListener('DOMContentLoaded', ()=>setTimeout(bindFit,50));
  }
})();
</script>
</body>
</html>
