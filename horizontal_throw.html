<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>水平投射ゲーム〜5球で10点取れ！〜</title>
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --accent:#6ae3ff; --accent2:#8effa1; --text:#e8edf2; --muted:#9aa7b3;
    --ok:#8effa1; --ng:#ff9aa8; --yellow:#ffd36a;
  }
  *{box-sizing:border-box}
  html, body{height:100%;}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif;
    background: radial-gradient(1200px 600px at 70% -10%, #1a1f38, #0b0e1a 60%), var(--bg);
    color:var(--text); display:flex; min-height:100svh; align-items:center; justify-content:center; padding:12px;
  }
  @supports (min-height: 100dvh){ body{ min-height:100dvh; } }

  .app{width:min(980px,100%); display:grid; gap:10px}
  .title{font-weight:700; letter-spacing:.02em; font-size:clamp(18px,3vw,28px); text-align:center}

  .challengeBox{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;
    padding:6px 10px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
  }
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:14px; background:rgba(255,255,255,.08); color:var(--yellow)}
  #challengeTextHUD{font-weight:700; color:#ff5b5b}
  #scoreHUD{font-variant-numeric: tabular-nums; font-weight:900}
  .great{color:#a7ff6a; font-weight:800; margin-left:8px}
  .good{color:var(--ok); font-weight:800; margin-left:8px}
  .ok{color:#ffd36a; font-weight:800; margin-left:8px}
  .bad{color:#ff9aa8; font-weight:800; margin-left:8px}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.00));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:10px 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
  }

  .roulette{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center}
  .bar{
    height:16px; background:#111528; border-radius:999px; overflow:hidden; position:relative;
    border:1px solid rgba(255,255,255,.08);
  }
  .fill{
    height:100%; width:0%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    transition: width .06s linear;
    box-shadow: 0 0 10px rgba(106,227,255,.6), inset 0 0 8px rgba(0,0,0,.3);
  }
  .speed{font-variant-numeric: tabular-nums; font-weight:800; letter-spacing:.02em; min-width:8ch; text-align:right; font-size:18px; color:#ff5b5b}

  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; justify-content:center}
  button {
    appearance:none; border:none; border-radius:12px;
    padding:12px 16px;
    font-weight:700; cursor:pointer;
    font-size: clamp(20px, 3.4vw, 30px);
    color:#03131a;
    background:linear-gradient(180deg, #8ff2ff, #6ae3ff);
    box-shadow: 0 8px 22px rgba(106,227,255,.35), inset 0 1px 0 rgba(255,255,255,.6);
  }
  @media (min-width: 820px) {
    button { font-size: clamp(26px, 3.2vw, 42px); padding: 14px 22px; }
  }
  button.secondary{
    background:linear-gradient(180deg, #d7e7ff, #b8cfff);
    box-shadow: 0 8px 22px rgba(184,207,255,.28), inset 0 1px 0 rgba(255,255,255,.6);
  }
  button:disabled{opacity:.5; cursor:not-allowed}

  .playgrid{display:grid; grid-template-columns: 1fr; gap:10px; align-items:start}
  @media (orientation: landscape){
    .playgrid{grid-template-columns: 1fr 0.9fr; grid-template-areas: 'scene readouts';}
    .scene{grid-area: scene}
    .readouts{grid-area: readouts}
  }

  /* ====== シーン（高さはJSでビューポートにフィット） ====== */
  .scene{
    position:relative; height:420px; border-radius:14px; overflow:hidden; margin-top:8px;
    background:
      linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)),
      radial-gradient(800px 260px at 50% 0%, rgba(106,227,255,.08), rgba(0,0,0,0) 60%),
      #0b1022;
    border:1px solid rgba(255,255,255,.08);
  }
  .ground{position:absolute; inset:auto 0 0 0; height:8px; background:#1a2039; box-shadow: 0 -2px 0 rgba(255,255,255,.06) inset}
  .meter{position:absolute; right:10px; top:10px; font-size:12px; color:var(--muted);
    background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); padding:6px 8px; border-radius:8px; z-index:3}

  .grid{position:absolute; inset:0 0 8px 0; pointer-events:none; z-index:0}
  .hgridline,.vgridline{position:absolute; background:rgba(255,255,255,.22); opacity:.7}
  .hgridline{left:8px; right:8px; height:1px;}
  .vgridline{top:8px; bottom:8px; width:1px;}
  .gridlabel{position:absolute; font-size:11px; color:var(--muted); background:rgba(0,0,0,.35); padding:1px 6px; border-radius:999px; border:1px solid rgba(255,255,255,.12)}
  .hlabel{ right:10px; transform:translateY(-50%); }
  .vlabel{ bottom:10px; transform:translateX(-50%); }

  /* 建物（x<0 の領域） */
  .building{
    position:absolute; left:0; bottom:8px; right:auto;
    background:linear-gradient(180deg, #8f95a3, #6f7482);
    border:1px solid rgba(255,255,255,.1);
    box-shadow: inset 0 6px 14px rgba(0,0,0,.25);
    z-index:1;
  }
  .building::after{ /* 窓のようなスリット */
    content:''; position:absolute; inset:10% 15% 10% 15%;
    background: repeating-linear-gradient( to-bottom, rgba(255,255,255,.06), rgba(255,255,255,.06) 8px, transparent 8px, transparent 16px);
  }

  .ball{
    position:absolute; width:18px; aspect-ratio:1; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff, #bfeaff 30%, #6ae3ff 45%, #0aa3c0 70%, #067089 100%);
    box-shadow: 0 8px 24px rgba(106,227,255,.45); z-index:2;
  }

  /* 速度ベクトル（球の右面から出る矢印） */
  .velvec{
    position:absolute; height:3px; background:#8ff2ff;
    box-shadow: 0 0 10px rgba(106,227,255,.6);
    transform-origin: left center;
    z-index:2;
  }
  .velvec::after{
    content:''; position:absolute; right:-6px; top:50%; transform:translateY(-50%) rotate(0deg);
    border-left:8px solid #8ff2ff; border-top:5px solid transparent; border-bottom:5px solid transparent;
    filter: drop-shadow(0 0 6px rgba(106,227,255,.6));
  }

  .target{
    position:absolute; width:14px; height:14px; border-radius:50%;
    border:2px solid #ffd36a; box-shadow:0 0 10px rgba(255,211,106,.5);
    transform:translate(-50%, 0%); /* 真上に表示 */
  }
  .target::after{
    content:''; position:absolute; inset:3px; border-radius:50%; border:2px solid rgba(255,211,106,.8);
  }

  .readouts{display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:8px}
  @media (max-width: 980px){ .readouts{grid-template-columns:1fr 1fr} }
  @media (orientation: portrait){ .readouts{grid-template-columns:1fr; align-content:start} }
  .stat{background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px}
  .stat .label{color:var(--muted); font-size:12px; letter-spacing:.02em}
  .stat .value{font-variant-numeric: tabular-nums; font-weight:800; font-size:22px}

  /* iPad横向き最適化：画面に収める */
  @media (orientation: landscape) and (min-width: 768px) and (max-width: 1180px) {
    .title{ font-size: 20px; }
    #challengeTextHUD{ font-size: 18px; }
    #scoreHUD, .speed{ font-size: 24px; }
    .stat .value{ font-size: 18px; }
    .stat .label{ font-size: 12px; }
    .bar{ height: 14px; }
    .actions{ gap:8px; }
    button{ padding:10px 14px; }
  }

  .submitBox{ display:none; margin-top:10px; padding:10px; border:1px solid rgba(255,255,255,.12); border-radius:12px; background:rgba(255,255,255,.06); }
  .submitBox h3{ margin:0 0 8px 0; font-size:16px; }
  .submitRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .submitRow input[type="text"]{ flex:1; min-width:180px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#0f1430; color:#fff; font-size:16px; }
  .submitRow button{ padding:10px 14px; border-radius:10px; border:none; font-weight:700; cursor:pointer; color:#03131a; background:linear-gradient(180deg, #b1ffd1, #7affaf); box-shadow: 0 8px 22px rgba(122,255,175,.28); }
  .helpText{ font-size:12px; color:#cfe3ff; opacity:.9; margin-top:6px; }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#0b1022; color:#eafff3; padding:10px 14px; border:1px solid rgba(255,255,255,.1); border-radius:10px; display:none; z-index:9999}
</style>
</head>
<body>
  <main class="app">
    <div class="title">水平投射ゲーム〜5球で10点取れ！〜</div>

    <div class="challengeBox" id="challengeBox">
      <span class="badge" id="roundBadgeHUD">ラウンド1/5</span>
      <span id="challengeTextHUD">—</span>
      <span id="resultTextHUD"></span>
      <span>｜スコア <strong id="scoreHUD">0点</strong></span>
    </div>

    <section class="card" id="card">
      <!-- ルーレット（0〜5 m/s を4秒で周回） -->
      <div class="roulette" aria-live="polite">
        <div class="bar" aria-label="初速ルーレット（0〜5 m/s を4秒で周回）">
          <div class="fill" id="fill"></div>
        </div>
        <div class="speed" id="speedLabel">0.00 m/s</div>
      </div>
      <div class="actions">
        <button id="lockBtn">投射！</button>
        <button id="retryBtn" class="secondary" disabled>次のラウンド</button>
        <button id="resetBtn" class="secondary" style="display:none">もう一度</button>
      </div>

      <div class="playgrid">
        <div class="scene" id="scene">
          <div class="meter">g = 9.8 m/s²</div>
          <div class="grid" id="grid"></div>

          <!-- ★建物（x<0 領域） -->
          <div class="building" id="building" aria-hidden="true"></div>

          <!-- 球と速度ベクトル -->
          <div class="ball" id="ball"></div>
          <div class="velvec" id="velvec" aria-hidden="true"></div>

          <div class="target" id="target"></div>
          <div class="ground"></div>
        </div>

        <div class="readouts" id="readouts">
          <div class="stat"><div class="label">現在位置 (x, y)</div><div class="value" id="posNow">0.00 m, 0.00 m</div></div>
          <div class="stat"><div class="label">飛行時間 T</div><div class="value" id="tVal">0.00 s</div></div>
          <div class="stat"><div class="label">着地点 xₗ</div><div class="value" id="xLandVal">0.00 m</div></div>
        </div>
      </div>
    </section>
  </main>

  <!-- 提出フォーム -->
  <div class="submitBox" id="submitBox" style="display:none" aria-live="polite">
    <h3>提出</h3>
    <div class="submitRow">
      <label for="studentId">4桁番号(年組番)：</label>
      <input id="studentId" type="text" placeholder="3143" inputmode="numeric" />
    </div>
    <div class="submitRow">
      <label for="studentName">氏名：</label>
      <input id="studentName" type="text" placeholder="海城太郎" />
      <button id="submitBtn">送信</button>
    </div>
    <div class="helpText" id="submitHelp">10点以上で提出できます。</div>
  </div>
  <div class="toast" id="toast"></div>

<script>
(() => {
  // ====== 物理 & ルール ======
  const g = 9.8; // m/s^2
  const vMin=0, vMax=5, cycleSec=4; // 0〜5 m/sを4秒で周回
  const Y_CANDIDATES = [4.9, 19.6, 44.1];
  const H_LINES = [4.9, 9.8, 14.7, 19.6, 24.5, 29.4, 34.3, 39.2, 44.1];
  const TARGET_CANDIDATES = [1,2,3,4,5]; // m
  const X_GRID_MAX = 5; // 垂直ライン 0〜5 m

  const maxRounds=5; let round=1; let score=0; let lastGainedPoints=0;

  // ====== DOM ======
  const fillEl=document.getElementById('fill');
  const speedLabel=document.getElementById('speedLabel');
  const lockBtn=document.getElementById('lockBtn');
  const retryBtn=document.getElementById('retryBtn');
  const resetBtn=document.getElementById('resetBtn');

  const scene=document.getElementById('scene');
  const gridEl=document.getElementById('grid');
  const buildingEl=document.getElementById('building');
  const ball=document.getElementById('ball');
  const velvec=document.getElementById('velvec');
  const targetEl=document.getElementById('target');

  const posNowEl=document.getElementById('posNow');
  const tValEl=document.getElementById('tVal');
  const xLandVal=document.getElementById('xLandVal');

  const roundBadgeHUD=document.getElementById('roundBadgeHUD');
  const challengeTextHUD=document.getElementById('challengeTextHUD');
  const resultTextHUD=document.getElementById('resultTextHUD');
  const scoreHUD=document.getElementById('scoreHUD');

  // 提出まわり
  const CONFIG = {
    SUBMIT_MODE: 'google_forms',
    GOOGLE_FORMS: {
      url: 'https://docs.google.com/forms/d/e/1FAIpQLSdclzAB4YrLDhGSKkAoOC4IzF91eYF0uaWZuzXnJkZvBXGC7Q/formResponse',
      entry: {
        studentId: 'entry.196095964',
        studentName: 'entry.914895046',
        totalScore: 'entry.1303752079',
        timestamp: 'entry.1852796806'
      }
    }
  };
  const submitBox = document.getElementById('submitBox');
  const submitBtn = document.getElementById('submitBtn');
  const studentIdInput = document.getElementById('studentId');
  const studentNameInput = document.getElementById('studentName');
  const toast = document.getElementById('toast');
  function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', 2000); }
  function showSubmitBox(){ submitBox.style.display='block'; studentIdInput.focus(); }
  async function submitResult(){
    if (score < 10) { showToast('スコアが10点未満のため提出できません'); return; }
    const studentId = studentIdInput.value.trim();
    const studentName = studentNameInput.value.trim();
    if(!studentId || !studentName){
      showToast('4桁番号と氏名を入力してください');
      return;
    }
    try{
      const fd = new FormData();
      fd.append(CONFIG.GOOGLE_FORMS.entry.studentId, studentId);
      fd.append(CONFIG.GOOGLE_FORMS.entry.studentName, studentName);
      fd.append(CONFIG.GOOGLE_FORMS.entry.totalScore, String(score));
      fd.append(CONFIG.GOOGLE_FORMS.entry.timestamp, new Date().toLocaleString());
      await fetch(CONFIG.GOOGLE_FORMS.url, { method:'POST', mode:'no-cors', body: fd });
      showToast('送信しました！（Googleフォーム）');
      submitBtn.disabled = true; studentIdInput.disabled = true; studentNameInput.disabled = true;
    }catch(e){
      console.error(e);
      showToast('送信に失敗しました…');
    }
  }
  if(submitBtn){ submitBtn.addEventListener('click', submitResult); }

  // ====== レイアウト・スケール ======
  const groundOffsetPx=8;
  const TARGET_OFFSET_ABOVE_LABEL = 28; // ターゲットを縦ラベルの真上に
  let scaleY = 8; // px/m（高さ）
  let scaleX = 40; // px/m（横）
  const origin = { x: 30, y: groundOffsetPx }; // 左下の原点（x=0, y=0）の画面座標(px)

  // 速度ベクトルの画面上のスケール
  const velScalePxPerMs = 4;  // 1 (m/s) あたりの px
  const velMaxLenPx = 120;    // 長さの上限

  // 現在の位置（m）
  let curX = 0, curY = 0;

  // シーン高さをビューポートにフィット（iPad横で1画面内）
  let baselineTop = null;
  function getVH(){
    const vvh = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
    return Math.min(window.innerHeight, vvh);
  }
  function fitSceneToViewport(){
    const vh = getVH();
    if(baselineTop === null){ baselineTop = scene.getBoundingClientRect().top; }
    const margin = 12;
    let desired = Math.floor(vh - baselineTop - margin);
    desired = Math.max(240, Math.min(desired, vh - margin));
    const prev = parseFloat(getComputedStyle(scene).height);
    if(!isNaN(prev) && Math.abs(prev - desired) < 2){ return; }
    scene.style.height = desired + 'px';
  }

  function fitScales(){
    const maxY = 46; // 44.1m ラインが確実に見えるように
    const h = scene.clientHeight - groundOffsetPx - 20;
    scaleY = Math.max(4, Math.min(12, h / maxY));

    const w = scene.clientWidth - origin.x - 16;
    scaleX = Math.max(24, Math.min(90, w / (X_GRID_MAX + 0.6)));
  }

  function toPxX(xm){ return origin.x + xm*scaleX; }
  function toPxY(ym){ return origin.y + ym*scaleY; }

  // ====== グリッド描画 ======
  function renderGrid(){
    gridEl.innerHTML = '';

    // 水平ライン
    for(const ym of H_LINES){
      const line = document.createElement('div');
      line.className = 'hgridline';
      line.style.bottom = toPxY(ym) + 'px';
      gridEl.appendChild(line);

      const lab = document.createElement('div');
      lab.className = 'gridlabel hlabel';
      lab.style.bottom = toPxY(ym) + 'px';
      lab.textContent = ym + ' m';
      gridEl.appendChild(lab);
    }

    // 床のラベル(0 m)
    const lab0 = document.createElement('div');
    lab0.className = 'gridlabel hlabel';
    lab0.style.bottom = toPxY(0) + 'px';
    lab0.textContent = '0 m';
    gridEl.appendChild(lab0);

    // 垂直ライン（x=0〜5m）
    for(let xm=0; xm<=X_GRID_MAX; xm++){
      const v = document.createElement('div');
      v.className = 'vgridline';
      v.style.left = toPxX(xm) + 'px';
      gridEl.appendChild(v);

      const lab = document.createElement('div');
      lab.className = 'gridlabel vlabel';
      lab.style.left = toPxX(xm) + 'px';
      lab.textContent = xm + ' m';
      gridEl.appendChild(lab);
    }
  }

  // ====== 建物（x<0 域）配置 ======
  function layoutBuilding(heightM){
    // 右端は x=0 の位置（= origin.x）。左端はシーン左端（x<0域）。
    const rightPx = origin.x;
    buildingEl.style.right = (scene.clientWidth - rightPx) + 'px'; // right を「シーン右端からの距離」で指定
    buildingEl.style.left = '0px';
    buildingEl.style.height = toPxY(heightM) + 'px';
  }

  // ====== 速度ベクトルの描画 ======
  function placeBallAt(xm, ym){
    curX = xm; curY = ym;
    ball.style.left = (toPxX(xm) - 9) + 'px';
    ball.style.bottom = toPxY(ym) + 'px';
  }
  function updateVelocityVector(vx, vy){
    // アンカー（球の中心から右半径ぶん外側）
    const anchorX = toPxX(curX) + 9; // 中心 + 半径
    const anchorY = toPxY(curY) + 9; // 中心

    const mag = Math.sqrt(vx*vx + vy*vy);
    const len = Math.min(velMaxLenPx, mag * velScalePxPerMs);
    const angleRad = Math.atan2(vy, vx); // 右が0、下向きは負

    velvec.style.width = len + 'px';
    velvec.style.left = anchorX + 'px';
    velvec.style.bottom = (anchorY - 1.5) + 'px'; // 中心合わせ（高さ3px）
    velvec.style.transform = `rotate(${angleRad}rad)`;
    // 矢印ヘッドは ::after で自動で末端に付く
  }

  // ====== サウンド ======
  let audioCtx=null;
  function beep(freq=880,duration=0.15,type='sine',gain=0.08){
    try{
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const t0=audioCtx.currentTime;
      const osc=audioCtx.createOscillator();
      const gnode=audioCtx.createGain();
      osc.type=type; osc.frequency.value=freq; gnode.gain.value=gain;
      osc.connect(gnode).connect(audioCtx.destination);
      osc.start(t0);
      gnode.gain.setValueAtTime(gain,t0);
      gnode.gain.exponentialRampToValueAtTime(0.0001,t0+duration);
      osc.stop(t0+duration+0.02);
    }catch(e){}
  }
  const okSound = ()=>beep(740,0.12);
  const goodSound = ()=>{beep(880,0.12); setTimeout(()=>beep(1175,0.12),120);};
  const greatSound= ()=>{beep(1047,0.10); setTimeout(()=>beep(1319,0.10),110); setTimeout(()=>beep(1661,0.14),230);};
  const wrongSound= ()=>{beep(220,0.25,'square',0.06); setTimeout(()=>beep(175,0.25,'square',0.05),120);};

  // ====== ルーレット ======
  let running=true; let locked=false; let t0Roulette=performance.now();
  function rouletteLoop(now){
    if(!running)return;
    const elapsed=(now-t0Roulette)/1000;
    const v=vMin+((elapsed%cycleSec)/cycleSec)*(vMax-vMin);
    updateSpeedUI(v);
    // ルーレット中は vx=v, vy=0（水平矢印）
    updateVelocityVector(v, 0);
    requestAnimationFrame(rouletteLoop);
  }
  function updateSpeedUI(v){
    const c=Math.max(vMin,Math.min(vMax,v));
    const ratio=(c-vMin)/(vMax-vMin);
    fillEl.style.width=(ratio*100).toFixed(2)+'%';
    speedLabel.textContent=c.toFixed(2)+' m/s';
  }

  // ====== ラウンドごとの初期条件 ======
  let y0 = 19.6;     // 初期高さ（m）
  let xTarget = 3;   // ターゲット（m）
  let tFlight = 0;   // 飛行時間（s）
  let xLand = 0;     // 着地点（m）

  function setupRound(){
    // 高さとターゲットをランダムに
    y0 = Y_CANDIDATES[Math.floor(Math.random()*Y_CANDIDATES.length)];
    xTarget = TARGET_CANDIDATES[Math.floor(Math.random()*TARGET_CANDIDATES.length)];
    challengeTextHUD.textContent = `初期高さ y₀ = ${y0} m｜ターゲット x = ${xTarget} m を狙え！`;
    resultTextHUD.textContent = '';
    roundBadgeHUD.textContent = `ラウンド${round}/${maxRounds}`;

    // レイアウト準備→スケール→グリッド→建物
    fitSceneToViewport();
    fitScales();
    renderGrid();
    layoutBuilding(y0);

    // 初期配置（x=0, y=y0）
    placeBallAt(0, y0);

    // ターゲット：縦ラベルの真上
    targetEl.style.left = toPxX(xTarget) + 'px';
    targetEl.style.bottom = (groundOffsetPx + TARGET_OFFSET_ABOVE_LABEL) + 'px';

    // 右側表示初期化
    posNowEl.textContent = `0.00 m, ${y0.toFixed(2)} m`;
    tValEl.textContent = '0.00 s';
    xLandVal.textContent = '0.00 m';

    // 初期の速度ベクトル（vx=ルーレット値が入るまで0）
    updateVelocityVector(0, 0);
  }

  // ====== アニメーション（水平投射：v=(v0,0)） ======
  function animateThrow(v0){
    // 厳密な飛行時間・着地点
    tFlight = Math.sqrt((2*y0)/g);
    xLand = v0 * tFlight;

    const start=performance.now();
    function step(now){
      const t = Math.max(0, (now-start)/1000);
      const tC = Math.min(tFlight, t);     // これ以上進まない

      const x = v0 * tC;                   // m
      const y = Math.max(0, y0 - 0.5*g*tC*tC);

      // 速度ベクトル（瞬間）
      const vx = v0;
      const vy = -g * tC;

      // 画面に反映
      placeBallAt(x, y);
      updateVelocityVector(vx, vy);

      // 右側表示
      posNowEl.textContent = `${x.toFixed(2)} m, ${y.toFixed(2)} m`;
      tValEl.textContent = tC.toFixed(2) + ' s';
      xLandVal.textContent = xLand.toFixed(2) + ' m';

      if(t < tFlight - 1e-3){
        requestAnimationFrame(step);
      }else{
        // ★着地を厳密に y=0 へスナップ
        placeBallAt(xLand, 0);
        updateVelocityVector(v0, -g * tFlight); // 着地直前の速度向き
        posNowEl.textContent = `${xLand.toFixed(2)} m, 0.00 m`;
        tValEl.textContent = tFlight.toFixed(2) + ' s';
        xLandVal.textContent = xLand.toFixed(2) + ' m';
        evaluateAndProceed();
      }
    }
    requestAnimationFrame(step);
  }

  // ====== 採点（<5%:3 / <10%:2 / <15%:1） ======
  function evaluateAndProceed(){
    const errPct = Math.abs(xLand - xTarget) / xTarget;
    let gained = 0;
    if(errPct < 0.05){ gained=3; score+=3; resultTextHUD.innerHTML = `<span class="great">great!!（誤差 ${(errPct*100).toFixed(1)}% / +${gained}点）</span>`; greatSound(); }
    else if(errPct < 0.10){ gained=2; score+=2; resultTextHUD.innerHTML = `<span class="good">good!（誤差 ${(errPct*100).toFixed(1)}% / +${gained}点）</span>`; goodSound(); }
    else if(errPct < 0.15){ gained=1; score+=1; resultTextHUD.innerHTML = `<span class="ok">ok（誤差 ${(errPct*100).toFixed(1)}% / +${gained}点）</span>`; okSound(); }
    else { resultTextHUD.innerHTML = `<span class="bad">miss…（誤差 ${(errPct*100).toFixed(1)}%）</span>`; wrongSound(); }

    scoreHUD.textContent = String(score) + '点';
    lastGainedPoints = gained;
    lockBtn.disabled=true; retryBtn.disabled=false;

    if(round>=maxRounds){
      const finalMsg = (score >= 10) ? '課題クリア！' : '10点目指してもう1度頑張ろう！';
      resultTextHUD.innerHTML =
        `<div>5回目の得点：<strong>+${lastGainedPoints}点</strong></div>` +
        `<div>全${maxRounds}回の合計スコア：<strong>${score}点</strong></div>`;
      challengeTextHUD.textContent = finalMsg;
      retryBtn.style.display='none';
      resetBtn.style.display='inline-block';
      if (score >= 10) { showSubmitBox(); }
      else { submitBox.style.display='none'; showToast('今回はスコアが10点未満のため提出できません'); }
    }
  }

  // ====== 進行制御 ======
  function setupNextRound(){
    if(round<maxRounds){ round += 1; }
    locked=false; running=true; t0Roulette=performance.now();
    lockBtn.disabled=false; retryBtn.disabled=true;
    setupRound();
    requestAnimationFrame(rouletteLoop);
    window.scrollTo({top:0, behavior:'instant'});
  }
  function resetGame(){
    round=1; score=0; lastGainedPoints=0; scoreHUD.textContent='0点';
    retryBtn.style.display='inline-block'; resetBtn.style.display='none';
    submitBox.style.display='none'; submitBtn.disabled=false; studentIdInput.disabled=false; studentNameInput.disabled=false;
    studentIdInput.value=''; studentNameInput.value='';
    locked=false; running=true; t0Roulette=performance.now();
    lockBtn.disabled=false; retryBtn.disabled=true;
    setupRound();
    requestAnimationFrame(rouletteLoop);
    window.scrollTo({top:0, behavior:'instant'});
  }

  lockBtn.addEventListener('click',()=>{
    if(locked)return; locked=true; running=false;
    const v=parseFloat(speedLabel.textContent.replace(' m/s',''));
    lockBtn.disabled=true; retryBtn.disabled=true;
    animateThrow(v);
  });
  retryBtn.addEventListener('click', setupNextRound);
  resetBtn.addEventListener('click', resetGame);
  submitBtn.addEventListener('click', submitResult);

  // リサイズ対応（常に1画面フィット）
  function handleResize(){
    baselineTop = null;
    fitSceneToViewport();
    fitScales();
    renderGrid();
    layoutBuilding(y0);
    // 位置を再配置
    placeBallAt(curX, curY);
    targetEl.style.left = toPxX(xTarget) + 'px';
    targetEl.style.bottom = (groundOffsetPx + TARGET_OFFSET_ABOVE_LABEL) + 'px';
    // 速度ベクトルも再描画（方向・大きさは直前のまま。ここでは水平にしておく）
    const v=parseFloat(speedLabel.textContent.replace(' m/s',''))||0;
    updateVelocityVector(v, 0);
  }
  window.addEventListener('resize', ()=>{ handleResize(); });
  window.addEventListener('orientationchange', ()=>setTimeout(handleResize, 200));
  if(window.visualViewport){
    window.visualViewport.addEventListener('resize', ()=>{ setTimeout(handleResize, 50); });
  }

  // 初期化
  requestAnimationFrame(rouletteLoop);
  setupRound();
})();
</script>
</body>
</html>
