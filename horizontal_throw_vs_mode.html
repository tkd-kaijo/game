<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>水平投射ゲーム 2人対戦（制限時間バトル）</title>
<style>
  :root{
    --bg:#0f1220; --pane:#14182b; --card:#171a2b; --accent:#6ae3ff; --accent2:#8effa1;
    --text:#e8edf2; --muted:#9aa7b3; --ok:#8effa1; --ng:#ff9aa8; --yellow:#ffd36a;
    --topbar-h: 56px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 600px at 70% -10%, #1a1f38, #0b0e1a 60%), var(--bg);
    color:var(--text); font-family: ui-sans-serif, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", system-ui, sans-serif;
    display:flex; min-height:100svh; align-items:stretch; justify-content:center;
    overflow:hidden; /* ページスクロール無しで完結 */
  }
  @supports (min-height: 100dvh){ body{ min-height:100dvh; } }

  .topbar{
    position:fixed; top:8px; left:50%; transform:translateX(-50%);
    display:flex; gap:16px; align-items:center; z-index:20;
    background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.12);
    padding:8px 14px; border-radius:14px; backdrop-filter: blur(6px);
    height: var(--topbar-h);
  }
  .topbar .title{font-weight:800; letter-spacing:.02em}
  .timer{font-variant-numeric: tabular-nums; font-weight:900; font-size:28px; color:#ffd36a}
  .startBtn{
    appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer;
    color:#03131a; background:linear-gradient(180deg, #b1ffd1, #7affaf);
    box-shadow: 0 8px 22px rgba(122,255,175,.28), inset 0 1px 0 rgba(255,255,255,.6);
  }

  .arena{
    width:min(1400px, 100%); margin:0 auto;
    /* 画面高にフィットさせ、上部トップバー分を余白で確保 */
    padding: calc(var(--topbar-h) + 10px) 10px 10px;
    height: 100dvh;
    display:grid; grid-template-columns: 1fr 1fr; gap:10px;
  }
  .pane{
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; position:relative;
    display:flex; flex-direction:column; min-height:0;
  }
  .pane header{
    display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px;
    flex:0 0 auto;
  }
  .name{font-weight:900; letter-spacing:.02em; font-size:20px}
  .score{font-variant-numeric: tabular-nums; font-weight:900; font-size:22px}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:13px; background:rgba(255,255,255,.08); color:var(--yellow)}

  .challenge{font-weight:900; color:#ff5b5b; margin-bottom:8px; flex:0 0 auto;}

  .roulette{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; flex:0 0 auto;}
  .bar{height:18px; background:#111528; border-radius:999px; overflow:hidden; position:relative; border:1px solid rgba(255,255,255,.08)}
  .fill{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2)); transition:width .06s linear; box-shadow:0 0 10px rgba(106,227,255,.6), inset 0 0 8px rgba(0,0,0,.3)}
  .speed{font-variant-numeric: tabular-nums; font-weight:900; letter-spacing:.02em; min-width:8ch; text-align:right; font-size:clamp(18px, 2.6vw, 34px); color:#ff5b5b}

  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; flex:0 0 auto;}
  .btn{
    appearance:none; border:none; border-radius:12px; padding:14px 20px; font-weight:900; cursor:pointer;
    color:#03131a; background:linear-gradient(180deg, #8ff2ff, #6ae3ff);
    box-shadow: 0 8px 22px rgba(106,227,255,.35), inset 0 1px 0 rgba(255,255,255,.6);
    font-size: clamp(22px, 2.6vw, 34px);
  }
  .btn:disabled{opacity:.5; cursor:not-allowed}

  /* 残り高さをここに全部入れる */
  .gridWrap{
    display:grid; grid-template-columns: 1fr 220px; gap:10px; align-items:stretch;
    flex:1 1 auto; min-height:0;
  }
  .scene{
    position:relative; height:100%;
    border-radius:14px; overflow:hidden;
    background: radial-gradient(800px 260px at 50% 0%, rgba(106,227,255,.08), rgba(0,0,0,0) 60%), #0b1022;
    border:1px solid rgba(255,255,255,.08);
  }

  .meter{position:absolute; right:10px; top:10px; font-size:12px; color:var(--muted);
    background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); padding:6px 8px; border-radius:8px; z-index:3}

  /* y<0 の茶色領域 */
  .subground{
    position:absolute; left:0; right:0;
    background:linear-gradient(180deg, #8b5e3c, #5e3b23);
    opacity:.55;
    z-index:0;
  }

  .grid{position:absolute; inset:0 0 8px 0; pointer-events:none; z-index:0}
  .hgridline,.vgridline,.zeroline{position:absolute; background:rgba(255,255,255,.22); opacity:.7}
  .hgridline{left:8px; right:8px; height:1px;}
  .vgridline{top:8px; bottom:8px; width:1px;}
  .zeroline{left:8px; right:8px; height:2px; background:rgba(255,255,255,.28);} /* y=0 細線 */
  .gridlabel{position:absolute; font-size:11px; color:var(--muted); background:rgba(0,0,0,.35); padding:1px 6px; border-radius:999px; border:1px solid rgba(255,255,255,.12); z-index:2}
  .hlabel{ right:10px; transform:translateY(-50%); }
  .vlabel{ transform:translateX(-50%); }

  /* 建物（x<0 の領域） */
  .building{
    position:absolute; left:0; right:auto;
    background:linear-gradient(180deg, #8f95a3, #6f7482);
    border:1px solid rgba(255,255,255,.1);
    box-shadow: inset 0 6px 14px rgba(0,0,0,.25);
    z-index:1;
  }
  .building::after{
    content:''; position:absolute; inset:10% 15% 10% 15%;
    background: repeating-linear-gradient( to-bottom, rgba(255,255,255,.06), rgba(255,255,255,.06) 8px, transparent 8px, transparent 16px);
  }

  .ball{
    position:absolute; width:18px; aspect-ratio:1; border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #fff, #bfeaff 30%, #6ae3ff 45%, #0aa3c0 70%, #067089 100%);
    box-shadow: 0 8px 24px rgba(106,227,255,.45); z-index:3;
  }

  /* 速度ベクトル（球の中心から） */
  .velvec{
    position:absolute; height:3px; background:#8ff2ff;
    box-shadow: 0 0 10px rgba(106,227,255,.6);
    transform-origin: left center;
    z-index:3;
  }
  .velvec::after{
    content:''; position:absolute; right:-6px; top:50%; transform:translateY(-50%);
    border-left:8px solid #8ff2ff; border-top:5px solid transparent; border-bottom:5px solid transparent;
    filter: drop-shadow(0 0 6px rgba(106,227,255,.6));
  }

  /* 軌跡キャンバス（球より下、建物より上） */
  .trail{
    position:absolute; inset:0 0 8px 0; z-index:2; pointer-events:none;
  }

  .target{
    position:absolute; width:14px; height:14px; border-radius:50%;
    border:2px solid #ffd36a; box-shadow:0 0 10px rgba(255,211,106,.5);
    transform:translate(-50%, 0%); z-index:3;
  }
  .target::after{ content:''; position:absolute; inset:3px; border-radius:50%; border:2px solid rgba(255,211,106,.8); }

  .readouts{display:grid; grid-template-columns: 1fr; gap:8px; overflow:auto;}
  .stat{background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:8px 10px}
  .stat .label{color:var(--muted); font-size:12px; letter-spacing:.02em}
  .stat .value{font-variant-numeric: tabular-nums; font-weight:900; font-size:20px}

  .result{margin-top:6px; min-height:26px}
  .great{color:#a7ff6a; font-weight:800}
  .good{color:var(--ok); font-weight:800}
  .ok{color:#ffd36a; font-weight:800}
  .bad{color:#ff9aa8; font-weight:800}

  .winner{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:30;
    background:rgba(0,0,0,.55); backdrop-filter: blur(3px);
  }
  .winnerCard{
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.18); padding:18px 22px; border-radius:16px; text-align:center;
    box-shadow: 0 20px 40px rgba(0,0,0,.35);
  }
  .winnerCard h2{ margin:0 0 8px; }
  .winnerBtns{ margin-top:10px; display:flex; gap:10px; justify-content:center; }

  .overlayPortrait{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:40;
    background:#0b0f20; color:#fff; text-align:center; padding:24px;
  }
  @media (orientation: portrait){ .overlayPortrait{ display:flex; } }
</style>
</head>
<body>
  <div class="overlayPortrait">
    <div>
      <h2>横画面にしてください</h2>
      <p>この対戦版は横向き専用です。端末を横に回転してください。</p>
    </div>
  </div>

  <div class="topbar">
    <div class="title">水平投射ゲーム 2人対戦</div>

    <!-- 制限時間入力（スタート前に表示） -->
    <div id="limitWrap" style="display:flex; gap:8px; align-items:center;">
      <span>制限時間</span>
      <input type="number" id="limitSec" value="30" min="5" max="600" step="5"
             style="width:84px; font-weight:700; text-align:right; border-radius:10px; padding:6px 8px;">
      <span>秒</span>
    </div>

    <!-- カウントダウン（スタート後に表示） -->
    <div class="timer" id="timer" style="display:none">30.0</div>

    <button class="startBtn" id="startBtn">対戦スタート</button>
  </div>

  <main class="arena">
    <!-- === プレイヤーA === -->
    <section class="pane" id="paneA">
      <header>
        <div class="name">プレイヤーA</div>
        <div><span class="badge" id="roundA">Ready</span></div>
        <div>スコア <span class="score" id="scoreA">0</span></div>
      </header>
      <div class="challenge" id="challengeA">—</div>

      <div class="roulette" aria-label="初速ルーレット（0〜6 m/s を4秒で周回）">
        <div class="bar"><div class="fill" id="fillA"></div></div>
        <div class="speed" id="speedA">0.00 m/s</div>
      </div>
      <div class="actions">
        <button class="btn" id="fireA">投射！(Aキー)</button>
      </div>

      <div class="gridWrap">
        <div class="scene" id="sceneA">
          <div class="meter">g = 9.8 m/s²</div>

          <!-- y<0 の茶色帯 -->
          <div class="subground" id="subA" aria-hidden="true"></div>

          <div class="grid" id="gridA"></div>
          <canvas class="trail" id="trailA"></canvas>

          <!-- 建物（x<0 域） -->
          <div class="building" id="bldA" aria-hidden="true"></div>

          <!-- 球＆速度ベクトル＆ターゲット -->
          <div class="ball" id="ballA"></div>
          <div class="velvec" id="vecA" aria-hidden="true"></div>
          <div class="target" id="tgtA"></div>

          <div class="ground"></div>
        </div>
        <div class="readouts">
          <div class="stat"><div class="label">現在位置 (x, y)</div><div class="value" id="posA">0.00 m, 0.00 m</div></div>
          <div class="stat"><div class="label">飛行時間 T</div><div class="value" id="tA">0.00 s</div></div>
          <div class="stat"><div class="label">着地点 xₗ</div><div class="value" id="xA">0.00 m</div></div>
          <div class="result" id="resA"></div>
        </div>
      </div>
    </section>

    <!-- === プレイヤーB === -->
    <section class="pane" id="paneB">
      <header>
        <div class="name">プレイヤーB</div>
        <div><span class="badge" id="roundB">Ready</span></div>
        <div>スコア <span class="score" id="scoreB">0</span></div>
      </header>
      <div class="challenge" id="challengeB">—</div>

      <div class="roulette" aria-label="初速ルーレット（0〜6 m/s を4秒で周回）">
        <div class="bar"><div class="fill" id="fillB"></div></div>
        <div class="speed" id="speedB">0.00 m/s</div>
      </div>
      <div class="actions">
        <button class="btn" id="fireB">投射！(Lキー)</button>
      </div>

      <div class="gridWrap">
        <div class="scene" id="sceneB">
          <div class="meter">g = 9.8 m/s²</div>

          <!-- y<0 の茶色帯 -->
          <div class="subground" id="subB" aria-hidden="true"></div>

          <div class="grid" id="gridB"></div>
          <canvas class="trail" id="trailB"></canvas>

          <!-- 建物（x<0 域） -->
          <div class="building" id="bldB" aria-hidden="true"></div>

          <!-- 球＆速度ベクトル＆ターゲット -->
          <div class="ball" id="ballB"></div>
          <div class="velvec" id="vecB" aria-hidden="true"></div>
          <div class="target" id="tgtB"></div>

          <div class="ground"></div>
        </div>
        <div class="readouts">
          <div class="stat"><div class="label">現在位置 (x, y)</div><div class="value" id="posB">0.00 m, 0.00 m</div></div>
          <div class="stat"><div class="label">飛行時間 T</div><div class="value" id="tB">0.00 s</div></div>
          <div class="stat"><div class="label">着地点 xₗ</div><div class="value" id="xB">0.00 m</div></div>
          <div class="result" id="resB"></div>
        </div>
      </div>
    </section>
  </main>

  <div class="winner" id="winner">
    <div class="winnerCard">
      <h2 id="winnerTitle">結果</h2>
      <div id="winnerDetail"></div>
      <div class="winnerBtns">
        <button class="startBtn" id="restartBtn">もう一度</button>
      </div>
    </div>
  </div>

<script>
(() => {
  /* ====== 物理・表示共通設定 ====== */
  const g = 9.8;
  const vMin=0, vMax=6, cycleSec=4;       // ← 0〜6 m/s を4秒で周回
  const Y0S=[4.9,19.6,44.1];              // 初期高さ
  const H_LINES=[4.9,9.8,14.7,19.6,24.5,29.4,34.3,39.2,44.1]; // 高さライン
  const TARGETS=[1,2,3,4,5];              // ターゲット位置（m）
  const X_GRID_MAX=6;                      // 距離目盛の最大（画面スケール用）

  const BALL_D=18, BALL_R=BALL_D/2;
  const BOTTOM_VISIBLE_M = 3.2;  // y=-3.2 m まで表示
  const Y_MAX_VISIBLE   = 50;    // 上限 50 m
  const TOP_PAD_PX = 0;
  const groundOffsetPx = 8;
  const DIST_LABEL_Y_M = -2.6;

  /* ====== サウンド ====== */
  let audioCtx=null;
  function beep(freq=880,duration=0.15,type='sine',gain=0.08){
    try{
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const t0=audioCtx.currentTime;
      const osc=audioCtx.createOscillator();
      const gnode=audioCtx.createGain();
      osc.type=type; osc.frequency.value=freq; gnode.gain.value=gain;
      osc.connect(gnode).connect(audioCtx.destination);
      osc.start(t0);
      gnode.gain.setValueAtTime(gain,t0);
      gnode.gain.exponentialRampToValueAtTime(0.0001,t0+duration);
      osc.stop(t0+duration+0.02);
    }catch(e){}
  }
  const okSound = ()=>beep(740,0.12);
  const goodSound = ()=>{beep(880,0.12); setTimeout(()=>beep(1175,0.12),120);};
  const greatSound= ()=>{beep(1047,0.10); setTimeout(()=>beep(1319,0.10),110); setTimeout(()=>beep(1661,0.14),230);};
  const wrongSound= ()=>{beep(220,0.25,'square',0.06); setTimeout(()=>beep(175,0.25,'square',0.05),120);};

  /* ====== プレイヤークラス（水平投射） ====== */
  class PlayerH {
    constructor(id){
      // DOM
      this.scene = document.getElementById('scene'+id);
      this.grid  = document.getElementById('grid'+id);
      this.sub   = document.getElementById('sub'+id);
      this.trail = document.getElementById('trail'+id);
      this.bld   = document.getElementById('bld'+id);
      this.ball  = document.getElementById('ball'+id);
      this.vec   = document.getElementById('vec'+id);
      this.tgt   = document.getElementById('tgt'+id);

      this.fill  = document.getElementById('fill'+id);
      this.speedL= document.getElementById('speed'+id);
      this.fire  = document.getElementById('fire'+id);

      this.challengeText = document.getElementById('challenge'+id);
      this.posNow = document.getElementById('pos'+id);
      this.tNow   = document.getElementById('t'+id);
      this.xLandV = document.getElementById('x'+id);
      this.result = document.getElementById('res'+id);
      this.scoreEl= document.getElementById('score'+id);
      this.roundBadge = document.getElementById('round'+id);

      // 状態
      this.score=0; this.locked=false; this.runningRoulette=false; this.t0Roulette=0;
      this.inFlight=false; this.stopped=false; this.onLanded=null;

      // スケール系
      this.origin = {x:30, y:groundOffsetPx};
      this.scaleX=40; this.scaleY=8; this.bottomPadPx=0;

      // 物理状態
      this.y0=19.6; this.v0=0;
      this.tFlight=0; this.xLand=0;
      this.curX=0; this.curY=0;

      // 軌跡
      this.trailPts=[];

      // クリック
      this.fire.addEventListener('click', ()=>{
        if(this.locked || this.fire.disabled) return;
        this.locked=true; this.fire.disabled=true;
        const v=parseFloat(this.speedL.textContent.replace(' m/s',''))||0;
        this.v0=v; this.animate();
      });

      // 初期表示
      this.resetView();
    }

    /* ---------- 表示座標変換 ---------- */
    toPxX(xm){ return this.origin.x + xm*this.scaleX; }
    toPxY(ym){ return this.origin.y + ym*this.scaleY; } // DOM: bottom基準
    toCanvasYCenter(ym){ return this.scene.clientHeight - (this.origin.y + ym*this.scaleY + BALL_R); }

    /* ---------- レイアウト/スケール ---------- */
    fitScales(){
      const h = this.scene.clientHeight;
      const w = this.scene.clientWidth;
      this.scaleY = Math.max(4, (h - TOP_PAD_PX) / (Y_MAX_VISIBLE + BOTTOM_VISIBLE_M));
      this.scaleX = Math.max(24, Math.min(90, (w - this.origin.x - 16) / (X_GRID_MAX + 0.6)));
      this.bottomPadPx = BOTTOM_VISIBLE_M * this.scaleY;
      this.origin.y = groundOffsetPx + this.bottomPadPx;
    }
    layoutSubground(){
      this.sub.style.bottom = `${this.toPxY(-BOTTOM_VISIBLE_M)}px`;
      this.sub.style.height = `${BOTTOM_VISIBLE_M * this.scaleY}px`;
    }
    layoutBuilding(){
      const rightPx = this.origin.x;
      this.bld.style.right = (this.scene.clientWidth - rightPx) + 'px';
      this.bld.style.left = '0px';
      this.bld.style.bottom = `${this.toPxY(0)}px`;
      this.bld.style.height = (this.y0 * this.scaleY) + 'px';
    }
    renderGrid(){
      this.grid.innerHTML='';
      // 高さラインとラベル（真横）
      for(const ym of H_LINES){
        const line=document.createElement('div');
        line.className='hgridline';
        line.style.bottom = this.toPxY(ym)+'px';
        this.grid.appendChild(line);
        const lab=document.createElement('div');
        lab.className='gridlabel hlabel';
        lab.style.bottom = this.toPxY(ym)+'px';
        lab.textContent = `${ym} m`;
        this.grid.appendChild(lab);
      }
      // y=0
      const zero=document.createElement('div'); zero.className='zeroline';
      zero.style.bottom = this.toPxY(0)+'px'; this.grid.appendChild(zero);
      const lab0=document.createElement('div'); lab0.className='gridlabel hlabel';
      lab0.style.bottom = this.toPxY(0)+'px'; lab0.textContent='0 m'; this.grid.appendChild(lab0);
      // 距離目盛（縦線＋ラベルは y=-2.6m へ）
      const yLabelPx = this.toPxY(DIST_LABEL_Y_M);
      for(let xm=0; xm<=X_GRID_MAX; xm++){
        const v=document.createElement('div'); v.className='vgridline';
        v.style.left=this.toPxX(xm)+'px'; this.grid.appendChild(v);
        const lab=document.createElement('div'); lab.className='gridlabel vlabel';
        lab.style.left=this.toPxX(xm)+'px'; lab.style.bottom=yLabelPx+'px';
        lab.textContent = `${xm} m`;
        this.grid.appendChild(lab);
      }
    }
    resizeTrail(){
      const dpr = window.devicePixelRatio || 1;
      const rect = this.scene.getBoundingClientRect();
      this.trail.width  = Math.floor(rect.width * dpr);
      this.trail.height = Math.floor((rect.height - groundOffsetPx) * dpr);
      this.trail.style.width  = rect.width + 'px';
      this.trail.style.height = (rect.height - groundOffsetPx) + 'px';
      const ctx = this.trail.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      this.redrawTrail();
    }
    clearTrail(){
      const ctx = this.trail.getContext('2d');
      ctx.clearRect(0,0,this.trail.width,this.trail.height);
    }
    drawTrailSeg(a,b){
      const ctx = this.trail.getContext('2d');
      ctx.lineWidth=2; ctx.strokeStyle='#6ae3ff';
      ctx.shadowColor='rgba(106,227,255,.6)'; ctx.shadowBlur=6;
      ctx.beginPath();
      ctx.moveTo(this.toPxX(a.x), this.toCanvasYCenter(a.y));
      ctx.lineTo(this.toPxX(b.x), this.toCanvasYCenter(b.y));
      ctx.stroke(); ctx.shadowBlur=0;
    }
    redrawTrail(){
      this.clearTrail();
      for(let i=1;i<this.trailPts.length;i++) this.drawTrailSeg(this.trailPts[i-1], this.trailPts[i]);
    }

    /* ---------- オブジェクト配置 ---------- */
    placeBall(x,y){
      this.curX=x; this.curY=y;
      this.ball.style.left = (this.toPxX(x)-BALL_R)+'px';
      this.ball.style.bottom = this.toPxY(y)+'px';
    }
    updateVector(vx,vy){
      const cx = this.toPxX(this.curX);
      const cy = this.toPxY(this.curY) + BALL_R;
      const speed = Math.sqrt(vx*vx + vy*vy);
      const len = Math.min(120, speed * 4); // px
      const ang = Math.atan2(-vy*this.scaleY, vx*this.scaleX); // CSSは下向き正
      this.vec.style.width = len+'px';
      this.vec.style.left  = cx+'px';
      this.vec.style.bottom= (cy-1.5)+'px';
      this.vec.style.transform = `rotate(${ang}rad)`;
    }

    /* ---------- UI/ルーレット ---------- */
    startRoulette(){
      this.runningRoulette=true; this.t0Roulette=performance.now();
      const loop=(now)=>{
        if(!this.runningRoulette) return;
        const el=(now-this.t0Roulette)/1000;
        const v=vMin + ((el%cycleSec)/cycleSec)*(vMax-vMin);
        this.updateSpeedUI(v); this.updateVector(v,0);
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    }
    stopRoulette(){ this.runningRoulette=false; }
    updateSpeedUI(v){
      const c=Math.max(vMin,Math.min(vMax,v));
      const ratio=(c-vMin)/(vMax-vMin);
      this.fill.style.width=(ratio*100).toFixed(2)+'%';
      this.speedL.textContent=c.toFixed(2)+' m/s';
    }

    /* ---------- ラウンド構成 ---------- */
    pickChallenge(){
      this.y0 = Y0S[Math.floor(Math.random()*Y0S.length)];
      this.xTarget = TARGETS[Math.floor(Math.random()*TARGETS.length)];
      this.challengeText.textContent = `初期高さ y₀ = ${this.y0} m｜ターゲット x = ${this.xTarget} m を狙え！`;
      // 画面再レイアウト
      this.fitScales(); this.layoutSubground(); this.renderGrid(); this.layoutBuilding(); this.resizeTrail();
      // 初期配置
      this.placeBall(0, this.y0);
      this.trailPts=[{x:0, y:this.y0}]; this.clearTrail();
      // ターゲット表示（y=0）
      this.tgt.style.left = this.toPxX(this.xTarget)+'px';
      this.tgt.style.bottom= this.toPxY(0)+'px';
      // readouts
      this.posNow.textContent = `0.00 m, ${this.y0.toFixed(2)} m`;
      this.tNow.textContent   = '0.00 s';
      this.xLandV.textContent = '0.00 m';
      this.updateVector(0,0);
    }

    /* ---------- 投射アニメ ---------- */
    animate(){
      this.inFlight=true;
      this.tFlight = Math.sqrt(2*this.y0/g);
      this.xLand   = this.v0 * this.tFlight;
      const t0 = performance.now();

      const step=(now)=>{
        const t = Math.max(0,(now-t0)/1000);
        const tc= Math.min(this.tFlight, t);
        const x = this.v0 * tc;
        const y = Math.max(0, this.y0 - 0.5*g*tc*tc);
        const vx= this.v0;
        const vy= -g*tc;

        // 軌跡（中心）
        const last=this.trailPts[this.trailPts.length-1];
        const cur={x,y}; this.trailPts.push(cur); this.drawTrailSeg(last,cur);

        this.placeBall(x,y); this.updateVector(vx,vy);

        this.posNow.textContent = `${x.toFixed(2)} m, ${y.toFixed(2)} m`;
        this.tNow.textContent   = tc.toFixed(2)+' s';
        this.xLandV.textContent = this.xLand.toFixed(2)+' m';

        if(t < this.tFlight - 1e-3){ requestAnimationFrame(step); }
        else{
          // y=0 にスナップして終了
          this.placeBall(this.xLand, 0);
          this.updateVector(this.v0, -g*this.tFlight);
          const last2=this.trailPts[this.trailPts.length-1];
          const endp={x:this.xLand, y:0}; this.trailPts.push(endp); this.drawTrailSeg(last2,endp);

          this.grade();
          this.inFlight=false;
          if(typeof this.onLanded==='function') this.onLanded();
        }
      };
      requestAnimationFrame(step);
    }

    /* ---------- 採点（距離の相対誤差） ---------- */
    grade(){
      const err = Math.abs(this.xLand - this.xTarget)/this.xTarget;
      let add=0, cls='bad', txt='miss…';
      if(err<0.05){ add=3; cls='great'; txt='great!!'; greatSound(); }
      else if(err<0.10){ add=2; cls='good'; txt='good!'; goodSound(); }
      else if(err<0.15){ add=1; cls='ok';   txt='ok';    okSound(); }
      else { wrongSound(); }
      if(add>0) this.updateScore(this.score+add);
      this.result.innerHTML = `<span class="${cls}">${txt}（誤差 ${(err*100).toFixed(1)}% / +${add}点）</span>`;

      if(this.stopped){ /* タイムアップ後はここで止める */ return; }

      // 次の課題へ
      this.locked=false; this.fire.disabled=false;
      this.pickChallenge();
    }

    /* ---------- スコア＆状態 ---------- */
    updateScore(v){ this.score=v; this.scoreEl.textContent=String(v); }
    enablePlay(on){ this.fire.disabled=!on; this.roundBadge.textContent = on ? 'Go!' : 'Ready'; }
    onStart(){ this.stopped=false; this.enablePlay(true); this.startRoulette(); this.pickChallenge(); }
    onTimeUp(){ this.stopped=true; this.enablePlay(false); this.stopRoulette(); this.locked=true; }
    resetView(){
      this.score=0; this.scoreEl.textContent='0'; this.result.textContent='';
      this.enablePlay(false); this.locked=false; this.updateSpeedUI(0);
      this.fitScales(); this.layoutSubground(); this.renderGrid(); this.resizeTrail();
      this.y0=19.6; this.placeBall(0,this.y0); this.updateVector(0,0);
      this.tgt.style.left=this.toPxX(3)+'px'; this.tgt.style.bottom=this.toPxY(0)+'px';
      this.layoutBuilding();
      this.posNow.textContent=`0.00 m, ${this.y0.toFixed(2)} m`; this.tNow.textContent='0.00 s'; this.xLandV.textContent='0.00 m';
    }

    /* ---------- 外部レイアウト変化 ---------- */
    onResize(){
      this.fitScales(); this.layoutSubground(); this.renderGrid(); this.layoutBuilding(); this.resizeTrail();
      this.placeBall(this.curX, this.curY);
      this.tgt.style.left=this.toPxX(this.xTarget||3)+'px';
      this.tgt.style.bottom=this.toPxY(0)+'px';
      const v = parseFloat(this.speedL.textContent.replace(' m/s',''))||0;
      if(!this.inFlight) this.updateVector(v,0);
    }
  }

  /* ====== タイマ/勝敗管理 ====== */
  const timerEl = document.getElementById('timer');
  const startBtn= document.getElementById('startBtn');
  const limitWrap = document.getElementById('limitWrap');
  const limitSec  = document.getElementById('limitSec');
  const winner    = document.getElementById('winner');
  const winnerTitle = document.getElementById('winnerTitle');
  const winnerDetail= document.getElementById('winnerDetail');
  const restartBtn  = document.getElementById('restartBtn');

  const A = new PlayerH('A');
  const B = new PlayerH('B');

  let timeUp=false, ticking=false, tRemain=+limitSec.value||30, lastTs=0, rafId=null;
  let pendingLandings=0;

  function showWinner(){
    const a=A.score, b=B.score;
    winnerTitle.textContent = (a>b) ? '勝者：プレイヤーA' : (b>a) ? '勝者：プレイヤーB' : '引き分け';
    winnerDetail.textContent = `A: ${a} 点　/　B: ${b} 点`;
    winner.style.display='flex';
    // 入力UIを復帰
    limitSec.disabled=false; limitWrap.style.display='flex'; timerEl.style.display='none';
  }
  function hideWinner(){ winner.style.display='none'; }

  function startMatch(){
    hideWinner(); timeUp=false; pendingLandings=0;
    // 入力→カウント表示へ
    limitWrap.style.display='none'; limitSec.disabled=true; timerEl.style.display='block';
    tRemain = Math.max(1, Number(limitSec.value)||30); timerEl.textContent=tRemain.toFixed(1);
    lastTs=0; ticking=true;

    // 初期化＆開始
    A.resetView(); B.resetView();
    A.onStart(); B.onStart();

    const tick=(ts)=>{
      if(!ticking) return;
      if(!lastTs) lastTs=ts;
      const dt=(ts-lastTs)/1000; lastTs=ts;
      tRemain=Math.max(0, tRemain-dt); timerEl.textContent=tRemain.toFixed(1);

      if(tRemain>0){ rafId=requestAnimationFrame(tick); }
      else{
        ticking=false; timeUp=true;
        A.onTimeUp(); B.onTimeUp();
        pendingLandings = (A.inFlight?1:0) + (B.inFlight?1:0);
        if(pendingLandings===0) showWinner();
        else{
          const landed=()=>{ pendingLandings=Math.max(0,pendingLandings-1); if(pendingLandings===0){ A.onLanded=B.onLanded=null; showWinner(); } };
          A.onLanded=landed; B.onLanded=landed;
        }
      }
    };
    requestAnimationFrame(tick);
  }

  function prepareNext(){
    hideWinner(); ticking=false; if(rafId) cancelAnimationFrame(rafId); lastTs=0;
    limitSec.disabled=false; limitWrap.style.display='flex'; timerEl.style.display='none';
    A.resetView(); B.resetView(); A.enablePlay(false); B.enablePlay(false);
  }

  startBtn.addEventListener('click', startMatch);
  restartBtn.addEventListener('click', prepareNext);

  // キーボード：A / L
  window.addEventListener('keydown',(e)=>{
    if(e.repeat) return;
    if(timeUp) return;
    const k=e.key.toLowerCase();
    if(k==='a' && !A.fire.disabled && !A.locked) A.fire.click();
    if(k==='l' && !B.fire.disabled && !B.locked) B.fire.click();
  });

  // レイアウト変化
  function handleResize(){ A.onResize(); B.onResize(); }
  window.addEventListener('resize', handleResize);
  window.addEventListener('orientationchange', ()=>setTimeout(handleResize,150));
  window.addEventListener('DOMContentLoaded', ()=>setTimeout(handleResize,50));
})();
</script>
</body>
</html>